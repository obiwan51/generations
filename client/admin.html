<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generations JS - Server Admin</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #1a1a2e; 
            color: #eee;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #30475e;
        }
        .header h1 { font-size: 1.5rem; color: #e94560; }
        .header .status { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 0.9rem;
        }
        .status-dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: #4caf50;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 
            0%, 100% { opacity: 1; } 
            50% { opacity: 0.5; } 
        }

        /* Layout */
        .container { display: flex; min-height: calc(100vh - 60px); }
        
        /* Sidebar */
        .sidebar {
            width: 200px;
            background: #16213e;
            padding: 20px 0;
            border-right: 1px solid #30475e;
        }
        .nav-item {
            padding: 12px 25px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .nav-item:hover { background: #1a1a2e; }
        .nav-item.active { 
            background: #1a1a2e; 
            border-left-color: #e94560;
            color: #e94560;
        }
        .nav-item svg { width: 18px; height: 18px; }

        /* Main Content */
        .main { flex: 1; padding: 25px; overflow-y: auto; }
        .page { display: none; }
        .page.active { display: block; }
        .page-title { 
            font-size: 1.4rem; 
            margin-bottom: 20px; 
            color: #e94560;
            border-bottom: 1px solid #30475e;
            padding-bottom: 10px;
        }

        /* Cards */
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .card {
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #30475e;
        }
        .card-label { font-size: 0.85rem; color: #888; margin-bottom: 5px; }
        .card-value { font-size: 1.8rem; font-weight: bold; color: #4caf50; }
        .card-value.warning { color: #ff9800; }
        .card-value.danger { color: #f44336; }

        /* Tables */
        .table-container { background: #16213e; border-radius: 10px; overflow: hidden; border: 1px solid #30475e; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #30475e; }
        th { background: #0f3460; font-weight: 600; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #888; font-size: 0.9rem; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            background: #1a1a2e;
            border: 1px solid #30475e;
            border-radius: 5px;
            color: #eee;
            font-size: 1rem;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #e94560;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary { background: #e94560; color: white; }
        .btn-primary:hover { background: #d13550; }
        .btn-success { background: #4caf50; color: white; }
        .btn-success:hover { background: #43a047; }
        .btn-warning { background: #ff9800; color: white; }
        .btn-warning:hover { background: #f57c00; }
        .btn-danger { background: #f44336; color: white; }
        .btn-danger:hover { background: #d32f2f; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }

        /* Toggle Switch */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle {
            position: relative;
            width: 50px;
            height: 26px;
        }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #30475e;
            border-radius: 26px;
            transition: 0.3s;
        }
        .toggle .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: 0.3s;
        }
        .toggle input:checked + .slider { background: #4caf50; }
        .toggle input:checked + .slider:before { transform: translateX(24px); }

        /* Section */
        .section { margin-bottom: 30px; }
        .section-title { font-size: 1.1rem; margin-bottom: 15px; color: #ccc; }

        /* Grid layouts */
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }

        /* JSON Editor */
        .json-editor {
            font-family: 'Courier New', monospace;
            min-height: 300px;
            resize: vertical;
        }

        /* Action Bar */
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Registry Item */
        .registry-item {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #30475e;
            margin-bottom: 10px;
        }
        .registry-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .registry-item-title { font-weight: bold; color: #e94560; }
        .registry-item-id { color: #888; font-size: 0.85rem; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: #16213e;
            padding: 25px;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid #30475e;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-title { font-size: 1.2rem; color: #e94560; }
        .modal-close { 
            background: none; 
            border: none; 
            color: #888; 
            font-size: 1.5rem; 
            cursor: pointer; 
        }
        .modal-close:hover { color: #fff; }

        /* Confirm Dialog */
        .confirm-text { margin-bottom: 20px; line-height: 1.6; }
        .confirm-actions { display: flex; gap: 10px; justify-content: flex-end; }

        /* Progress Bar */
        .progress-bar {
            background: #30475e;
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s;
        }
        .progress-fill.green { background: #4caf50; }
        .progress-fill.yellow { background: #ff9800; }
        .progress-fill.red { background: #f44336; }

        /* Recipe Builder Styles */
        .recipe-builder {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
        }
        .recipe-sidebar {
            background: #16213e;
            border-radius: 10px;
            border: 1px solid #30475e;
            padding: 15px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        .recipe-sidebar-title {
            font-size: 1rem;
            color: #e94560;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30475e;
        }
        .item-search {
            width: 100%;
            padding: 8px 12px;
            background: #1a1a2e;
            border: 1px solid #30475e;
            border-radius: 5px;
            color: #eee;
            margin-bottom: 10px;
        }
        .item-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .draggable-item {
            background: #1a1a2e;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #30475e;
            cursor: grab;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            user-select: none;
        }
        .draggable-item:hover {
            border-color: #e94560;
            background: #222244;
        }
        .draggable-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .draggable-item .item-icon {
            width: 24px;
            height: 24px;
            background: #30475e;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        .draggable-item .item-name {
            flex: 1;
            font-size: 0.9rem;
        }
        .draggable-item .item-key {
            font-size: 0.75rem;
            color: #888;
        }
        .recipe-main {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .recipe-form-container {
            background: #16213e;
            border-radius: 10px;
            border: 1px solid #30475e;
            padding: 20px;
        }
        .recipe-formula {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .recipe-slot {
            width: 120px;
            height: 100px;
            background: #1a1a2e;
            border: 2px dashed #30475e;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }
        .recipe-slot.drag-over {
            border-color: #e94560;
            background: rgba(233, 69, 96, 0.1);
        }
        .recipe-slot.filled {
            border-style: solid;
            border-color: #4caf50;
        }
        .recipe-slot-label {
            font-size: 0.75rem;
            color: #888;
            position: absolute;
            top: 5px;
            left: 8px;
        }
        .recipe-slot-content {
            text-align: center;
            padding: 5px;
        }
        .recipe-slot-content .slot-name {
            font-weight: bold;
            font-size: 0.85rem;
            color: #e94560;
        }
        .recipe-slot-content .slot-key {
            font-size: 0.7rem;
            color: #888;
        }
        .recipe-slot-clear {
            position: absolute;
            top: 3px;
            right: 3px;
            background: #f44336;
            border: none;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 10px;
            display: none;
        }
        .recipe-slot.filled .recipe-slot-clear {
            display: block;
        }
        .recipe-operator {
            font-size: 2rem;
            color: #888;
            font-weight: bold;
        }
        .recipe-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .recipe-details .form-group.full-width {
            grid-column: 1 / -1;
        }
        .recipe-list-container {
            background: #16213e;
            border-radius: 10px;
            border: 1px solid #30475e;
            overflow: hidden;
        }
        .recipe-list-header {
            background: #0f3460;
            padding: 12px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .recipe-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .recipe-list-item {
            padding: 12px 15px;
            border-bottom: 1px solid #30475e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.2s;
        }
        .recipe-list-item:hover {
            background: rgba(255,255,255,0.02);
        }
        .recipe-list-item.selected {
            background: rgba(233, 69, 96, 0.1);
            border-left: 3px solid #e94560;
        }
        .recipe-list-item-info {
            flex: 1;
        }
        .recipe-list-item-name {
            font-weight: bold;
            color: #e94560;
        }
        .recipe-list-item-formula {
            font-size: 0.85rem;
            color: #888;
            margin-top: 3px;
        }
        .recipe-list-item-actions {
            display: flex;
            gap: 5px;
        }
        .empty-slot-text {
            color: #555;
            font-size: 0.8rem;
        }
        
        /* Sprite Upload Styles */
        .sprite-upload-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .sprite-select-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .sprite-select-row select {
            flex: 1;
        }
        .sprite-preview {
            width: 64px;
            height: 64px;
            border: 2px dashed #3a3a3a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
            overflow: hidden;
        }
        .sprite-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .sprite-preview-empty {
            color: #555;
            font-size: 0.75rem;
            text-align: center;
        }
        .sprite-upload-btn {
            padding: 6px 12px;
            background: #2a5a2a;
            border: none;
            border-radius: 4px;
            color: #fff;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .sprite-upload-btn:hover {
            background: #3a7a3a;
        }
        .sprite-upload-input {
            display: none;
        }
        
        /* Master-Detail Layout */
        .master-detail {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            height: calc(100vh - 180px);
        }
        .master-list {
            background: #1e1e2e;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .master-list-header {
            padding: 15px;
            border-bottom: 1px solid #3a3a4a;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .master-list-title {
            font-weight: 600;
            color: #e8a87c;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .master-list-search {
            width: 100%;
            padding: 8px 12px;
            background: #2a2a3a;
            border: 1px solid #3a3a4a;
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
        }
        .master-list-items {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .master-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 4px;
        }
        .master-item:hover {
            background: #2a2a3a;
        }
        .master-item.selected {
            background: #3a3a5a;
            border-left: 3px solid #e8a87c;
        }
        .master-item-icon {
            width: 40px;
            height: 40px;
            background: #2a2a3a;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .master-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .master-item-info {
            flex: 1;
            min-width: 0;
        }
        .master-item-name {
            font-weight: 500;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .master-item-key {
            font-size: 0.75rem;
            color: #888;
        }
        
        .detail-pane {
            background: #1e1e2e;
            border-radius: 8px;
            padding: 20px;
            overflow-y: auto;
        }
        .detail-pane-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
        }
        .detail-pane-empty svg {
            width: 64px;
            height: 64px;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        .detail-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #3a3a4a;
        }
        .detail-header-icon {
            width: 80px;
            height: 80px;
            background: #2a2a3a;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .detail-header-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .detail-header-info h3 {
            margin: 0 0 5px 0;
            color: #e8a87c;
            font-size: 1.5rem;
        }
        .detail-header-info .detail-key {
            color: #888;
            font-size: 0.9rem;
        }
        .detail-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .detail-form .form-group.full-width {
            grid-column: span 2;
        }
        .detail-form .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #aaa;
            font-size: 0.85rem;
        }
        .detail-form .form-group input,
        .detail-form .form-group select {
            width: 100%;
            padding: 10px 12px;
            background: #2a2a3a;
            border: 1px solid #3a3a4a;
            border-radius: 6px;
            color: #fff;
        }
        .detail-form .form-group input:focus,
        .detail-form .form-group select:focus {
            border-color: #e8a87c;
            outline: none;
        }
        .detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #3a3a4a;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 0;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #e8a87c;
        }
        .checkbox-group label {
            margin: 0 !important;
            cursor: pointer;
        }
        
        /* Category badges for Items */
        .category-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 10px;
            text-transform: uppercase;
            font-weight: 600;
            margin-left: 6px;
        }
        .category-badge.cat-tool { background: #3b82f6; color: white; }
        .category-badge.cat-material { background: #8b5cf6; color: white; }
        .category-badge.cat-food { background: #22c55e; color: white; }
        .category-badge.cat-weapon { background: #ef4444; color: white; }
        .category-badge.cat-ammo { background: #f97316; color: white; }
        .category-badge.cat-container { background: #06b6d4; color: white; }
        .category-badge.cat-structure { background: #a855f7; color: white; }
        .category-badge.cat-carcass { background: #6b7280; color: white; }
        .category-badge.cat-other { background: #374151; color: white; }
        
        /* Form section titles */
        .form-section-title {
            grid-column: span 2;
            font-size: 0.9rem;
            color: #e8a87c;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #3a3a4a;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéÆ Generations JS - Server Admin</h1>
        <div class="status">
            <div class="status-dot"></div>
            <span>Server Online</span>
            <span id="uptime">‚Äî</span>
        </div>
    </div>

    <div class="container">
        <nav class="sidebar">
            <div class="nav-item active" data-page="stats">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 13h2v8H3v-8zm4-6h2v14H7V7zm4 3h2v11h-2V10zm4-6h2v17h-2V4zm4 9h2v8h-2v-8z"/></svg>
                Statistics
            </div>
            <div class="nav-item" data-page="config">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>
                Configuration
            </div>
            <div class="nav-item" data-page="modules">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 8h4V4H4v4zm6 12h4v-4h-4v4zm-6 0h4v-4H4v4zm0-6h4v-4H4v4zm6 0h4v-4h-4v4zm6-10v4h4V4h-4zm-6 4h4V4h-4v4zm6 6h4v-4h-4v4zm0 6h4v-4h-4v4z"/></svg>
                Modules
            </div>
            <div class="nav-item" data-page="world">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                World
            </div>
            <div class="nav-item" data-page="players">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                Players
            </div>
            <div class="nav-item" data-page="resources">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3L1 9l4 2.18v6L12 21l7-3.82v-6l2-1.09V17h2V9L12 3zm6.82 6L12 12.72 5.18 9 12 5.28 18.82 9zM17 15.99l-5 2.73-5-2.73v-3.72L12 15l5-2.73v3.72z"/></svg>
                Resources
            </div>
            <div class="nav-item" data-page="items">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg>
                Items
            </div>
            <div class="nav-item" data-page="animals">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4.5 9.5c.28 0 .5.22.5.5v.5c0 .28-.22.5-.5.5S4 10.78 4 10.5V10c0-.28.22-.5.5-.5zm15 0c.28 0 .5.22.5.5v.5c0 .28-.22.5-.5.5s-.5-.22-.5-.5V10c0-.28.22-.5.5-.5zM12 2C9.24 2 7 4.24 7 7v3.5H5c0-1.38-1.12-2.5-2.5-2.5S0 9.12 0 10.5 1.12 13 2.5 13H5v1c0 3.31 2.69 6 6 6h2c3.31 0 6-2.69 6-6v-1h2.5c1.38 0 2.5-1.12 2.5-2.5S22.88 8 21.5 8 19 9.12 19 10.5V14h-2V7c0-2.76-2.24-5-5-5z"/></svg>
                Animals
            </div>
            <div class="nav-item" data-page="recipes">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
                Recipes
            </div>
        </nav>

        <main class="main">
            <!-- Statistics Page -->
            <div id="page-stats" class="page active">
                <h2 class="page-title">üìä Server Statistics</h2>
                
                <div class="section">
                    <h3 class="section-title">Time & Seasons</h3>
                    <div class="cards">
                        <div class="card">
                            <div class="card-label">Current Year</div>
                            <div class="card-value" id="stat-year">0</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Current Season</div>
                            <div class="card-value" id="stat-season" style="font-size:1.2rem;">Spring</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Server Uptime</div>
                            <div class="card-value" id="stat-uptime" style="font-size:1.2rem;">0h 0m</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">Population</h3>
                    <div class="cards">
                        <div class="card">
                            <div class="card-label">Current Population</div>
                            <div class="card-value" id="stat-population">0</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Peak Population</div>
                            <div class="card-value" id="stat-peak">0</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Total Players</div>
                            <div class="card-value" id="stat-total-players">0</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Total Deaths</div>
                            <div class="card-value danger" id="stat-deaths">0</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Total Births</div>
                            <div class="card-value" id="stat-births">0</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Current Generation</div>
                            <div class="card-value" id="stat-generation">1</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">Demographics</h3>
                    <div class="cards">
                        <div class="card">
                            <div class="card-label">Babies (0-3)</div>
                            <div class="card-value" id="stat-babies">0</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Adults (3-40)</div>
                            <div class="card-value" id="stat-adults">0</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Elders (40+)</div>
                            <div class="card-value" id="stat-elders">0</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Male / Female</div>
                            <div class="card-value" id="stat-gender" style="font-size:1.2rem;">0 / 0</div>
                        </div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="section">
                        <h3 class="section-title">Death Causes</h3>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Cause</th><th>Count</th></tr></thead>
                                <tbody id="death-causes-table"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="section">
                        <h3 class="section-title">Animals in World</h3>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Animal</th><th>Count</th></tr></thead>
                                <tbody id="animals-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">World Objects</h3>
                    <div class="cards">
                        <div class="card">
                            <div class="card-label">World Size</div>
                            <div class="card-value" id="stat-world-size">0</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Total Objects</div>
                            <div class="card-value" id="stat-total-objects">0</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Total Animals</div>
                            <div class="card-value" id="stat-total-animals">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Page -->
            <div id="page-config" class="page">
                <h2 class="page-title">‚öôÔ∏è Server Configuration</h2>
                <form id="config-form">
                    <div class="grid-2">
                        <div class="form-group">
                            <label>Aging Speed (seconds per year)</label>
                            <input type="number" name="agingSpeed" min="1" max="3600">
                        </div>
                        <div class="form-group">
                            <label>Hunger Speed (hunger lost per tick)</label>
                            <input type="number" name="hungerSpeed" min="0.1" max="10" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Max Age</label>
                            <input type="number" name="maxAge" min="10" max="200">
                        </div>
                        <div class="form-group">
                            <label>Max Hunger</label>
                            <input type="number" name="maxHunger" min="10" max="200">
                        </div>
                        <div class="form-group">
                            <label>Spawn Eve Age</label>
                            <input type="number" name="spawnEveAge" min="14" max="40">
                        </div>
                        <div class="form-group">
                            <label>XP Per Hunt</label>
                            <input type="number" name="xpPerHunt" min="1" max="100">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                </form>
            </div>

            <!-- Modules Page -->
            <div id="page-modules" class="page">
                <h2 class="page-title">üß© Game Modules</h2>
                <div class="section">
                    <p style="color:#888;margin-bottom:20px;">Toggle game features on or off. Changes apply immediately.</p>
                    
                    <div class="registry-item">
                        <div class="registry-item-header">
                            <div>
                                <div class="registry-item-title">Animal Movement</div>
                                <div class="registry-item-id">Allows animals to wander around the world</div>
                            </div>
                            <div class="toggle-switch">
                                <label class="toggle">
                                    <input type="checkbox" id="module-animalMovement">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="registry-item">
                        <div class="registry-item-header">
                            <div>
                                <div class="registry-item-title">Carnivore Aggression</div>
                                <div class="registry-item-id">Allows carnivores to attack players</div>
                            </div>
                            <div class="toggle-switch">
                                <label class="toggle">
                                    <input type="checkbox" id="module-carnivoreAggression">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="registry-item">
                        <div class="registry-item-header">
                            <div>
                                <div class="registry-item-title">Weather System</div>
                                <div class="registry-item-id">Enables weather effects and seasonal changes</div>
                            </div>
                            <div class="toggle-switch">
                                <label class="toggle">
                                    <input type="checkbox" id="module-weatherEnabled">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- World Page -->
            <div id="page-world" class="page">
                <h2 class="page-title">üåç World Management</h2>
                
                <div class="section">
                    <h3 class="section-title">World Generation Parameters</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Noise Scale: <span id="val-noiseScale">80</span></label>
                            <input type="range" id="slider-noiseScale" min="40" max="150" value="80" step="5" style="width: 100%;">
                            <small style="color: #888;">Larger = bigger continents</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Water Threshold: <span id="val-waterThreshold">0.28</span></label>
                            <input type="range" id="slider-waterThreshold" min="0.10" max="0.45" value="0.28" step="0.01" style="width: 100%;">
                            <small style="color: #888;">Higher = more water</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Edge Bias Start: <span id="val-edgeBiasStart">0.80</span></label>
                            <input type="range" id="slider-edgeBiasStart" min="0.70" max="0.95" value="0.80" step="0.01" style="width: 100%;">
                            <small style="color: #888;">When edges become water</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Edge Bias Strength: <span id="val-edgeBiasStrength">3</span></label>
                            <input type="range" id="slider-edgeBiasStrength" min="1" max="6" value="3" step="0.5" style="width: 100%;">
                            <small style="color: #888;">How fast edges turn to water</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Spawn Protection: <span id="val-spawnProtectionRadius">0</span></label>
                            <input type="range" id="slider-spawnProtectionRadius" min="0" max="0.30" value="0" step="0.01" style="width: 100%;">
                            <small style="color: #888;">Center safe zone (0 = disabled)</small>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.9rem;">Forest Moisture: <span id="val-forestMoisture">0.60</span></label>
                            <input type="range" id="slider-forestMoisture" min="0.50" max="0.75" value="0.60" step="0.01" style="width: 100%;">
                            <small style="color: #888;">More forest with higher moisture</small>
                        </div>
                    </div>
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" id="btn-apply-params">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>
                            Apply & Regenerate World
                        </button>
                        <button class="btn" id="btn-reset-params">Reset to Defaults</button>
                        <button class="btn" id="btn-save-world" style="margin-left: auto;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                            Save World Now
                        </button>
                    </div>
                    <div id="save-status" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
                </div>

                <div class="section">
                    <h3 class="section-title">World Actions</h3>
                    <div class="registry-item">
                        <div class="registry-item-header">
                            <div>
                                <div class="registry-item-title">Reinitialize World</div>
                                <div class="registry-item-id">Regenerate with random seed. Current parameters preserved.</div>
                            </div>
                            <button class="btn btn-danger" id="btn-reinitialize">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                                Reinitialize
                            </button>
                        </div>
                        <div style="margin-top: 10px; padding: 10px; background: rgba(255,193,7,0.1); border-left: 3px solid #ffc107; border-radius: 4px;">
                            <strong>Note:</strong> World state is automatically saved to disk:
                            <ul style="margin: 5px 0 0 20px; font-size: 0.9rem;">
                                <li>30 seconds after last object change (minimum 15s between saves)</li>
                                <li>On server shutdown (Ctrl+C)</li>
                                <li>When applying new world parameters</li>
                            </ul>
                            Auto-save is throttled to prevent file corruption during high activity.
                        </div>
                    </div>
                    
                    <div class="registry-item">
                        <div class="registry-item-header">
                            <div>
                                <div class="registry-item-title">Reset Map Objects</div>
                                <div class="registry-item-id">Clear all trees, rocks, animals, and items. Terrain remains.</div>
                            </div>
                            <button class="btn btn-warning" id="btn-reset-map">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                Reset Objects
                            </button>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">World Map</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center;">
                        <button class="btn" id="btn-refresh-map">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                            Refresh Map
                        </button>
                        <span id="map-status" style="font-size: 0.8rem; color: #888;"></span>
                    </div>
                    <div id="map-container" style="background: #000; border-radius: 8px; overflow: hidden; position: relative; height: 600px; display: flex; align-items: center; justify-content: center; border: 1px solid #30475e;">
                        <canvas id="world-map-canvas"></canvas>
                        <div id="map-loading" style="position: absolute; background: rgba(0,0,0,0.7); inset: 0; display: flex; align-items: center; justify-content: center; color: #eee; z-index: 10;">
                            <div>Loading map data...</div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">Top Resources in World</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Resource</th><th>Count</th><th>Percentage</th></tr></thead>
                            <tbody id="resources-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Players Page -->
            <div id="page-players" class="page">
                <h2 class="page-title">üë• Player Management</h2>
                
                <div class="section">
                    <h3 class="section-title">Active Players</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; justify-content: space-between;">
                        <div>
                            <span>Total Players: <strong id="player-count-badge">0</strong></span>
                        </div>
                        <button class="btn btn-sm btn-primary" id="btn-refresh-players">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                            Refresh
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.05); text-align: left;">
                                    <th style="padding: 10px;">ID / Name</th>
                                    <th style="padding: 10px;">IP Address</th>
                                    <th style="padding: 10px;">Age</th>
                                    <th style="padding: 10px;">Generation</th>
                                    <th style="padding: 10px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="players-table-body">
                                <tr>
                                    <td colspan="5" style="padding: 20px; text-align: center; color: #888;">No players online</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">Banned IPs</h3>
                    <div style="margin-bottom: 15px; display: flex; gap: 10px; align-items: center; justify-content: space-between;">
                        <div>
                            <span>Total Bans: <strong id="ban-count-badge">0</strong></span>
                        </div>
                        <button class="btn btn-sm btn-primary" id="btn-refresh-bans">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                            Refresh
                        </button>
                    </div>
                    <div class="table-container">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: rgba(255,255,255,0.05); text-align: left;">
                                    <th style="padding: 10px;">IP Address</th>
                                    <th style="padding: 10px; width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bans-table-body">
                                <tr>
                                    <td colspan="2" style="padding: 20px; text-align: center; color: #888;">No banned IPs</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Resources Page -->
            <div id="page-resources" class="page">
                <h2 class="page-title">üå≤ Resource Registry</h2>
                <p style="margin-bottom:15px;color:#888;font-size:0.9rem;">Natural resources that spawn in the world (bushes, trees, rocks, etc.)</p>
                <div class="master-detail">
                    <div class="master-list">
                        <div class="master-list-header">
                            <div class="master-list-title">
                                <span>Resources (<span id="resource-count">0</span>)</span>
                                <button class="btn btn-sm btn-primary" id="btn-add-resource">+ New</button>
                            </div>
                            <input type="text" class="master-list-search" id="resource-search" placeholder="Search resources...">
                        </div>
                        <div class="master-list-items" id="resources-list"></div>
                    </div>
                    <div class="detail-pane" id="resource-detail">
                        <div class="detail-pane-empty">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                            <p>Select a resource to view details</p>
                            <p style="font-size:0.85rem;">or click "+ New" to create one</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Items Page -->
            <div id="page-items" class="page">
                <h2 class="page-title">üéí Item Registry</h2>
                <p style="margin-bottom:15px;color:#888;font-size:0.9rem;">Craftable or obtainable items (tools, materials, weapons, food, etc.)</p>
                <div class="master-detail">
                    <div class="master-list">
                        <div class="master-list-header">
                            <div class="master-list-title">
                                <span>Items (<span id="item-count">0</span>)</span>
                                <button class="btn btn-sm btn-primary" id="btn-add-item">+ New</button>
                            </div>
                            <input type="text" class="master-list-search" id="item-search" placeholder="Search items...">
                        </div>
                        <div class="master-list-items" id="items-list"></div>
                    </div>
                    <div class="detail-pane" id="item-detail">
                        <div class="detail-pane-empty">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg>
                            <p>Select an item to view details</p>
                            <p style="font-size:0.85rem;">or click "+ New" to create one</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Animals Page -->
            <div id="page-animals" class="page">
                <h2 class="page-title">üêæ Animal Registry</h2>
                <div class="master-detail">
                    <div class="master-list">
                        <div class="master-list-header">
                            <div class="master-list-title">
                                <span>Animals (<span id="animal-count">0</span>)</span>
                                <button class="btn btn-sm btn-primary" id="btn-add-animal">+ New</button>
                            </div>
                            <input type="text" class="master-list-search" id="animal-search" placeholder="Search animals...">
                        </div>
                        <div class="master-list-items" id="animals-list"></div>
                    </div>
                    <div class="detail-pane" id="animal-detail">
                        <div class="detail-pane-empty">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4.5 9.5a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5zm15 0a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5zM12 2a8 8 0 0 1 8 8c0 2.21-.9 4.21-2.34 5.66L12 22l-5.66-6.34A8 8 0 1 1 12 2z"/></svg>
                            <p>Select an animal to view details</p>
                            <p style="font-size:0.85rem;">or click "+ New" to create one</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recipes Page -->
            <div id="page-recipes" class="page">
                <h2 class="page-title">üìú Recipe Manager</h2>
                
                <div class="recipe-builder">
                    <!-- Sidebar: Available Items -->
                    <div class="recipe-sidebar">
                        <div class="recipe-sidebar-title">üì¶ Available Items</div>
                        <input type="text" class="item-search" id="recipe-item-search" placeholder="Search items...">
                        <div class="item-list" id="recipe-item-list">
                            <!-- Items will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Main Area -->
                    <div class="recipe-main">
                        <!-- Recipe Form -->
                        <div class="recipe-form-container">
                            <h3 class="section-title" style="margin-top:0;">Create / Edit Recipe</h3>
                            
                            <!-- Visual Formula -->
                            <div class="recipe-formula">
                                <div class="recipe-slot" id="slot-tool" data-slot="tool">
                                    <span class="recipe-slot-label">üîß TOOL</span>
                                    <button class="recipe-slot-clear" onclick="clearSlot('tool')">√ó</button>
                                    <div class="recipe-slot-content">
                                        <span class="empty-slot-text">Drop here</span>
                                    </div>
                                </div>
                                <span class="recipe-operator">+</span>
                                <div class="recipe-slot" id="slot-target" data-slot="target">
                                    <span class="recipe-slot-label">üéØ TARGET</span>
                                    <button class="recipe-slot-clear" onclick="clearSlot('target')">√ó</button>
                                    <div class="recipe-slot-content">
                                        <span class="empty-slot-text">Drop here</span>
                                    </div>
                                </div>
                                <span class="recipe-operator">=</span>
                                <div class="recipe-slot" id="slot-result" data-slot="result">
                                    <span class="recipe-slot-label">‚ú® RESULT</span>
                                    <button class="recipe-slot-clear" onclick="clearSlot('result')">√ó</button>
                                    <div class="recipe-slot-content">
                                        <span class="empty-slot-text">Drop here</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Recipe Details -->
                            <div class="recipe-details">
                                <div class="form-group">
                                    <label>Recipe ID</label>
                                    <input type="text" id="recipe-id" placeholder="e.g., sharp_stone">
                                </div>
                                <div class="form-group">
                                    <label>Recipe Name</label>
                                    <input type="text" id="recipe-name" placeholder="e.g., Sharp Stone">
                                </div>
                                <div class="form-group full-width">
                                    <label>Description</label>
                                    <input type="text" id="recipe-description" placeholder="Describe how to craft this item">
                                </div>
                                <div class="form-group full-width">
                                    <label>Target Becomes (optional - target transforms instead of being removed)</label>
                                    <input type="text" id="recipe-target-becomes" placeholder="e.g., BERRY_BUSH_EMPTY">
                                </div>
                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="recipe-bare-hands">
                                        <label for="recipe-bare-hands">‚úã Bare Hands (no tool required)</label>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="recipe-target-persists">
                                        <label for="recipe-target-persists">üî• Target Persists (result goes to hand, e.g., cooking on fire)</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="display:flex;gap:10px;margin-top:15px;">
                                <button class="btn btn-primary" id="btn-save-recipe">üíæ Save Recipe</button>
                                <button class="btn" id="btn-clear-recipe">üóëÔ∏è Clear Form</button>
                            </div>
                        </div>
                        
                        <!-- Existing Recipes List -->
                        <div class="recipe-list-container">
                            <div class="recipe-list-header">
                                <span>üìã Existing Recipes (<span id="recipe-count">0</span>)</span>
                            </div>
                            <div class="recipe-list" id="recipe-list">
                                <!-- Recipes will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirm-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="confirm-title">Confirm Action</span>
                <button class="modal-close" onclick="closeModal('confirm-modal')">&times;</button>
            </div>
            <p class="confirm-text" id="confirm-text"></p>
            <div class="confirm-actions">
                <button class="btn" onclick="closeModal('confirm-modal')">Cancel</button>
                <button class="btn btn-danger" id="confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Resource/Animal Edit Modal -->
    <div class="modal-overlay" id="edit-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title" id="edit-modal-title">Edit Item</span>
                <button class="modal-close" onclick="closeModal('edit-modal')">&times;</button>
            </div>
            <form id="edit-form"></form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/admin-api';
        const ASSETS_BASE = 'http://localhost:3001/assets';
        let currentRegistry = { resources: {}, animals: {}, recipes: [] };
        let currentConfig = {};
        let statsInterval;
        let availableSprites = [];

        // Load available sprites
        async function loadSprites() {
            try {
                const res = await fetch(API_BASE + '/sprites');
                const data = await res.json();
                availableSprites = data.sprites || [];
            } catch (e) {
                console.error('Failed to load sprites:', e);
                availableSprites = [];
            }
        }

        // Generate sprite selector HTML
        function getSpriteSelectHtml(fieldName, currentValue, previewId) {
            const options = availableSprites.map(s => 
                `<option value="${s}" ${currentValue === s ? 'selected' : ''}>${s}</option>`
            ).join('');
            
            return `
                <div class="sprite-upload-group">
                    <div class="sprite-select-row">
                        <select name="${fieldName}" id="select-${fieldName}" onchange="updateSpritePreview('${previewId}', this.value)">
                            <option value="">-- No Sprite --</option>
                            ${options}
                        </select>
                        <label class="sprite-upload-btn">
                            üì§ Upload
                            <input type="file" class="sprite-upload-input" accept=".svg,.png,.jpg,.jpeg,.gif,.webp" 
                                   onchange="uploadSprite(this, '${fieldName}', '${previewId}')">
                        </label>
                    </div>
                    <div class="sprite-preview" id="${previewId}">
                        ${currentValue 
                            ? `<img src="${ASSETS_BASE}/${currentValue}" alt="Preview">` 
                            : '<span class="sprite-preview-empty">No sprite</span>'}
                    </div>
                </div>
            `;
        }

        // Update sprite preview
        function updateSpritePreview(previewId, filename) {
            const preview = document.getElementById(previewId);
            if (filename) {
                preview.innerHTML = `<img src="${ASSETS_BASE}/${filename}" alt="Preview">`;
            } else {
                preview.innerHTML = '<span class="sprite-preview-empty">No sprite</span>';
            }
        }

        // Upload sprite file
        async function uploadSprite(input, fieldName, previewId) {
            const file = input.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('sprite', file);
            
            try {
                const res = await fetch(API_BASE + '/upload-sprite', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                if (data.success) {
                    // Refresh sprites list
                    await loadSprites();
                    
                    // Update the select dropdown
                    const select = document.getElementById('select-' + fieldName);
                    if (select) {
                        // Add new option if not exists
                        let optionExists = false;
                        for (const opt of select.options) {
                            if (opt.value === data.filename) {
                                optionExists = true;
                                break;
                            }
                        }
                        if (!optionExists) {
                            const newOpt = document.createElement('option');
                            newOpt.value = data.filename;
                            newOpt.textContent = data.filename;
                            select.appendChild(newOpt);
                        }
                        select.value = data.filename;
                    }
                    
                    // Update preview
                    updateSpritePreview(previewId, data.filename);
                    alert('Sprite uploaded: ' + data.filename);
                } else {
                    alert('Upload failed: ' + data.message);
                }
            } catch (e) {
                alert('Upload error: ' + e.message);
            }
            
            // Clear the input
            input.value = '';
        }

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                item.classList.add('active');
                document.getElementById('page-' + item.dataset.page).classList.add('active');
            });
        });

        // Modal helpers
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function showConfirm(title, text, onConfirm) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-text').textContent = text;
            document.getElementById('confirm-btn').onclick = () => {
                closeModal('confirm-modal');
                onConfirm();
            };
            document.getElementById('confirm-modal').classList.add('active');
        }

        // Stats loading
        async function loadStats() {
            try {
                const res = await fetch(API_BASE + '/stats');
                const stats = await res.json();
                
                document.getElementById('stat-year').textContent = stats.currentYear;
                document.getElementById('stat-season').textContent = capitalize(stats.currentSeason);
                document.getElementById('stat-uptime').textContent = stats.uptime;
                document.getElementById('uptime').textContent = stats.uptime;
                
                document.getElementById('stat-population').textContent = stats.currentPopulation;
                document.getElementById('stat-peak').textContent = stats.peakPopulation;
                document.getElementById('stat-total-players').textContent = stats.totalPlayersEver;
                document.getElementById('stat-deaths').textContent = stats.totalDeaths;
                document.getElementById('stat-births').textContent = stats.totalBirths;
                document.getElementById('stat-generation').textContent = stats.currentGeneration;
                
                document.getElementById('stat-babies').textContent = stats.babiesAlive;
                document.getElementById('stat-adults').textContent = stats.adultsAlive;
                document.getElementById('stat-elders').textContent = stats.eldersAlive;
                document.getElementById('stat-gender').textContent = `${stats.maleCount} / ${stats.femaleCount}`;
                
                document.getElementById('stat-world-size').textContent = `${stats.worldSize}√ó${stats.worldSize}`;
                document.getElementById('stat-total-objects').textContent = stats.totalObjects;
                document.getElementById('stat-total-animals').textContent = stats.totalAnimals;

                // Death causes table
                const deathTable = document.getElementById('death-causes-table');
                deathTable.innerHTML = Object.entries(stats.deathsByCause || {})
                    .sort((a, b) => b[1] - a[1])
                    .map(([cause, count]) => `<tr><td>${cause}</td><td>${count}</td></tr>`)
                    .join('') || '<tr><td colspan="2" style="text-align:center;color:#888">No deaths yet</td></tr>';

                // Animals table
                const animalsTable = document.getElementById('animals-table');
                animalsTable.innerHTML = Object.entries(stats.animalCounts || {})
                    .sort((a, b) => b[1] - a[1])
                    .map(([name, count]) => `<tr><td>${name}</td><td>${count}</td></tr>`)
                    .join('') || '<tr><td colspan="2" style="text-align:center;color:#888">No animals</td></tr>';

                // Resources table (top 10)
                const resourcesTable = document.getElementById('resources-table');
                const totalRes = Object.values(stats.resourceCounts || {}).reduce((a, b) => a + b, 0);
                resourcesTable.innerHTML = Object.entries(stats.resourceCounts || {})
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                    .map(([name, count]) => {
                        const pct = totalRes ? ((count / totalRes) * 100).toFixed(1) : 0;
                        return `<tr><td>${name}</td><td>${count}</td><td>${pct}%</td></tr>`;
                    })
                    .join('') || '<tr><td colspan="3" style="text-align:center;color:#888">No resources</td></tr>';

            } catch (err) {
                console.error('Failed to load stats:', err);
            }
        }

        // Config loading
        async function loadConfig() {
            const res = await fetch(API_BASE + '/config');
            currentConfig = await res.json();
            
            for (const key in currentConfig) {
                const input = document.querySelector(`[name="${key}"]`);
                if (input) input.value = currentConfig[key];
            }
        }

        // Config save
        document.getElementById('config-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {};
            for (const [key, value] of formData) {
                data[key] = parseFloat(value);
            }
            await fetch(API_BASE + '/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            alert('Configuration saved!');
        });

        // Modules loading
        async function loadModules() {
            const res = await fetch(API_BASE + '/modules');
            const modules = await res.json();
            
            for (const key in modules) {
                const checkbox = document.getElementById('module-' + key);
                if (checkbox) checkbox.checked = modules[key];
            }
        }

        // Module toggle handlers
        ['animalMovement', 'carnivoreAggression', 'weatherEnabled'].forEach(mod => {
            document.getElementById('module-' + mod)?.addEventListener('change', async (e) => {
                await fetch(API_BASE + '/modules/' + mod, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: e.target.checked })
                });
            });
        });

        // World reinitialize
        document.getElementById('btn-reinitialize')?.addEventListener('click', () => {
            showConfirm(
                '‚ö†Ô∏è Reinitialize World',
                'This will regenerate the entire world! All objects, animals, and resources will be reset. Players will remain but may lose their inventory. Are you sure?',
                async () => {
                    await fetch(API_BASE + '/world/reinitialize', { method: 'POST' });
                    alert('World reinitialized!');
                    loadStats();
                }
            );
        });

        // Reset Map Objects
        document.getElementById('btn-reset-map')?.addEventListener('click', () => {
            showConfirm(
                '‚ö†Ô∏è Reset Map Objects',
                'This will clear ALL objects (trees, rocks, animals, items) from the world. The terrain (land/water) will stay the same. Are you sure?',
                async () => {
                    await fetch(API_BASE + '/world/reset-map', { method: 'POST' });
                    alert('Map objects cleared!');
                }
            );
        });

        // Registry loading
        async function loadRegistry() {
            const res = await fetch(API_BASE + '/registry');
            currentRegistry = await res.json();
            renderResources();
            renderItems();
            renderAnimals();
            renderRecipeItems();
            renderRecipeList();
        }

        // ================== RESOURCES ==================
        let selectedResourceKey = null;

        function renderResources(filter = '') {
            const container = document.getElementById('resources-list');
            const entries = Object.entries(currentRegistry.resources || {});
            const filterLower = filter.toLowerCase();
            
            document.getElementById('resource-count').textContent = entries.length;
            
            const filtered = entries.filter(([key, r]) => 
                r.name.toLowerCase().includes(filterLower) || 
                key.toLowerCase().includes(filterLower)
            );
            
            container.innerHTML = filtered.map(([key, r]) => {
                const sprite = r.asset || r.sprite || '';
                return `
                <div class="master-item ${selectedResourceKey === key ? 'selected' : ''}" data-key="${key}" onclick="selectResource('${key}')">
                    <div class="master-item-icon">
                        ${sprite ? `<img src="${ASSETS_BASE}/${sprite}" alt="">` : 'üì¶'}
                    </div>
                    <div class="master-item-info">
                        <div class="master-item-name">${r.name}</div>
                        <div class="master-item-key">${key}</div>
                    </div>
                </div>
            `}).join('');
        }

        function selectResource(key) {
            selectedResourceKey = key;
            renderResources(document.getElementById('resource-search')?.value || '');
            showResourceDetail(key);
        }

        function showResourceDetail(key) {
            const r = key ? currentRegistry.resources[key] : { id: getNextId('resources'), name: '', spawnRate: 0 };
            const isNew = !key;
            const sprite = r.asset || r.sprite || '';
            
            const detail = document.getElementById('resource-detail');
            detail.innerHTML = `
                <div class="detail-header">
                    <div class="detail-header-icon">
                        ${sprite ? `<img src="${ASSETS_BASE}/${sprite}" alt="">` : 'üì¶'}
                    </div>
                    <div class="detail-header-info">
                        <h3>${isNew ? 'New Resource' : r.name}</h3>
                        <span class="detail-key">${isNew ? 'Creating new resource' : `Key: ${key} | ID: ${r.id}`}</span>
                    </div>
                </div>
                <form id="resource-form" class="detail-form">
                    <div class="form-group">
                        <label>Key (internal name)</label>
                        <input type="text" name="key" value="${key || ''}" ${isNew ? '' : 'readonly'} required placeholder="e.g., BERRY_BUSH">
                    </div>
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" name="name" value="${r.name || ''}" required placeholder="e.g., Berry Bush">
                    </div>
                    <div class="form-group">
                        <label>ID (unique number)</label>
                        <input type="number" name="id" value="${r.id}" ${isNew ? '' : 'readonly'}>
                    </div>
                    <div class="form-group">
                        <label>Spawn Rate (0-1)</label>
                        <input type="number" name="spawnRate" value="${r.spawnRate || 0}" step="0.001" min="0" max="1">
                    </div>
                    <div class="form-group full-width">
                        <label>Sprite / Asset</label>
                        ${getSpriteSelectHtml('asset', sprite, 'preview-resource-detail')}
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="isEdible" id="res-edible" ${r.isEdible ? 'checked' : ''}>
                            <label for="res-edible">üçñ Is Edible</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Food Value</label>
                        <input type="number" name="foodValue" value="${r.foodValue || 0}" min="0">
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="isWeapon" id="res-weapon" ${r.isWeapon ? 'checked' : ''}>
                            <label for="res-weapon">‚öîÔ∏è Is Weapon</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="isLarge" id="res-large" ${r.isLarge ? 'checked' : ''}>
                            <label for="res-large">üèîÔ∏è Is Large (2x size)</label>
                        </div>
                    </div>
                </form>
                <div class="detail-actions">
                    <button class="btn btn-primary" onclick="saveResource('${key || ''}')">üíæ Save Resource</button>
                    ${!isNew ? `<button class="btn btn-danger" onclick="deleteResource('${key}')">üóëÔ∏è Delete</button>` : ''}
                    <button class="btn" onclick="clearResourceDetail()">Cancel</button>
                </div>
            `;
        }

        function clearResourceDetail() {
            selectedResourceKey = null;
            renderResources(document.getElementById('resource-search')?.value || '');
            document.getElementById('resource-detail').innerHTML = `
                <div class="detail-pane-empty">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"/></svg>
                    <p>Select a resource to view details</p>
                    <p style="font-size:0.85rem;">or click "+ New" to create one</p>
                </div>
            `;
        }

        async function saveResource(originalKey) {
            const form = document.getElementById('resource-form');
            const fd = new FormData(form);
            const newKey = fd.get('key').trim().toUpperCase().replace(/\s+/g, '_');
            
            if (!newKey) {
                alert('Please enter a key');
                return;
            }
            
            // If key changed and it's not a new resource, we need to delete the old one
            if (originalKey && originalKey !== newKey) {
                delete currentRegistry.resources[originalKey];
            }
            
            currentRegistry.resources[newKey] = {
                id: parseInt(fd.get('id')),
                name: fd.get('name'),
                asset: fd.get('asset') || undefined,
                spawnRate: parseFloat(fd.get('spawnRate')) || undefined,
                isEdible: fd.get('isEdible') === 'on',
                foodValue: parseInt(fd.get('foodValue')) || undefined,
                isWeapon: fd.get('isWeapon') === 'on',
                isLarge: fd.get('isLarge') === 'on' || undefined
            };
            
            await saveRegistry('resources');
            selectedResourceKey = newKey;
            renderResources(document.getElementById('resource-search')?.value || '');
            showResourceDetail(newKey);
            alert('Resource saved!');
        }

        function deleteResource(key) {
            showConfirm('Delete Resource', `Delete "${currentRegistry.resources[key]?.name || key}"?`, async () => {
                delete currentRegistry.resources[key];
                await saveRegistry('resources');
                clearResourceDetail();
            });
        }

        // ================== ANIMALS ==================
        let selectedAnimalKey = null;

        function renderAnimals(filter = '') {
            const container = document.getElementById('animals-list');
            const entries = Object.entries(currentRegistry.animals || {});
            const filterLower = filter.toLowerCase();
            
            document.getElementById('animal-count').textContent = entries.length;
            
            const filtered = entries.filter(([key, a]) => 
                a.name.toLowerCase().includes(filterLower) || 
                key.toLowerCase().includes(filterLower)
            );
            
            container.innerHTML = filtered.map(([key, a]) => {
                const sprite = a.assets?.alive || '';
                return `
                <div class="master-item ${selectedAnimalKey === key ? 'selected' : ''}" data-key="${key}" onclick="selectAnimal('${key}')">
                    <div class="master-item-icon">
                        ${sprite ? `<img src="${ASSETS_BASE}/${sprite}" alt="">` : 'üêæ'}
                    </div>
                    <div class="master-item-info">
                        <div class="master-item-name">${a.name}</div>
                        <div class="master-item-key">${key}</div>
                    </div>
                </div>
            `}).join('');
        }

        function selectAnimal(key) {
            selectedAnimalKey = key;
            renderAnimals(document.getElementById('animal-search')?.value || '');
            showAnimalDetail(key);
        }

        function showAnimalDetail(key) {
            const a = key ? currentRegistry.animals[key] : { id: getNextId('animals'), name: '', hp: 10, speed: 0.2 };
            const isNew = !key;
            const aliveSprite = a.assets?.alive || '';
            const deadSprite = a.assets?.dead || 'dead_animal.svg';
            
            const detail = document.getElementById('animal-detail');
            detail.innerHTML = `
                <div class="detail-header">
                    <div class="detail-header-icon">
                        ${aliveSprite ? `<img src="${ASSETS_BASE}/${aliveSprite}" alt="">` : 'üêæ'}
                    </div>
                    <div class="detail-header-info">
                        <h3>${isNew ? 'New Animal' : a.name}</h3>
                        <span class="detail-key">${isNew ? 'Creating new animal' : `Key: ${key} | ID: ${a.id}`}</span>
                    </div>
                </div>
                <form id="animal-form" class="detail-form">
                    <div class="form-group">
                        <label>Key (internal name)</label>
                        <input type="text" name="key" value="${key || ''}" ${isNew ? '' : 'readonly'} required placeholder="e.g., RABBIT">
                    </div>
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" name="name" value="${a.name || ''}" required placeholder="e.g., Rabbit">
                    </div>
                    <div class="form-group">
                        <label>ID (unique number)</label>
                        <input type="number" name="id" value="${a.id}" ${isNew ? '' : 'readonly'}>
                    </div>
                    <div class="form-group">
                        <label>HP (Health Points)</label>
                        <input type="number" name="hp" value="${a.hp || 10}" min="1">
                    </div>
                    <div class="form-group">
                        <label>Speed</label>
                        <input type="number" name="speed" value="${a.speed || 0.2}" step="0.05" min="0">
                    </div>
                    <div class="form-group">
                        <label>Spawn Rate (0-1)</label>
                        <input type="number" name="spawnRate" value="${a.spawnRate || 0}" step="0.001" min="0" max="1">
                    </div>
                    <div class="form-group full-width">
                        <label>Biomes (comma-separated: grassland, forest, desert, swamp, water)</label>
                        <input type="text" name="biomes" value="${(a.biomes || []).join(', ')}" placeholder="e.g., grassland, forest">
                    </div>
                    <div class="form-group full-width">
                        <label>Alive Sprite</label>
                        ${getSpriteSelectHtml('assetAlive', aliveSprite, 'preview-animal-alive-detail')}
                    </div>
                    <div class="form-group full-width">
                        <label>Dead Sprite</label>
                        ${getSpriteSelectHtml('assetDead', deadSprite, 'preview-animal-dead-detail')}
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="isCarnivore" id="ani-carnivore" ${a.isCarnivore ? 'checked' : ''}>
                            <label for="ani-carnivore">ü•© Is Carnivore</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Aggression (0-1)</label>
                        <input type="number" name="aggression" value="${a.aggression || 0}" step="0.1" min="0" max="1">
                    </div>
                </form>
                <div class="detail-actions">
                    <button class="btn btn-primary" onclick="saveAnimal('${key || ''}')">üíæ Save Animal</button>
                    ${!isNew ? `<button class="btn btn-danger" onclick="deleteAnimal('${key}')">üóëÔ∏è Delete</button>` : ''}
                    <button class="btn" onclick="clearAnimalDetail()">Cancel</button>
                </div>
            `;
        }

        function clearAnimalDetail() {
            selectedAnimalKey = null;
            renderAnimals(document.getElementById('animal-search')?.value || '');
            document.getElementById('animal-detail').innerHTML = `
                <div class="detail-pane-empty">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4.5 9.5a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5zm15 0a2.5 2.5 0 1 1 0 5 2.5 2.5 0 0 1 0-5zM12 2a8 8 0 0 1 8 8c0 2.21-.9 4.21-2.34 5.66L12 22l-5.66-6.34A8 8 0 1 1 12 2z"/></svg>
                    <p>Select an animal to view details</p>
                    <p style="font-size:0.85rem;">or click "+ New" to create one</p>
                </div>
            `;
        }

        async function saveAnimal(originalKey) {
            const form = document.getElementById('animal-form');
            const fd = new FormData(form);
            const newKey = fd.get('key').trim().toUpperCase().replace(/\s+/g, '_');
            
            if (!newKey) {
                alert('Please enter a key');
                return;
            }
            
            if (originalKey && originalKey !== newKey) {
                delete currentRegistry.animals[originalKey];
            }
            
            currentRegistry.animals[newKey] = {
                id: parseInt(fd.get('id')),
                name: fd.get('name'),
                assets: {
                    alive: fd.get('assetAlive') || undefined,
                    dead: fd.get('assetDead') || 'dead_animal.svg',
                    decayed: 'decayed_animal.svg',
                    bones: 'bones.svg'
                },
                hp: parseInt(fd.get('hp')),
                speed: parseFloat(fd.get('speed')) || 0.2,
                spawnRate: parseFloat(fd.get('spawnRate')) || undefined,
                biomes: fd.get('biomes') ? fd.get('biomes').split(',').map(b => b.trim().toLowerCase()).filter(b => b) : undefined,
                isCarnivore: fd.get('isCarnivore') === 'on',
                aggression: parseFloat(fd.get('aggression')) || 0
            };
            
            await saveRegistry('animals');
            selectedAnimalKey = newKey;
            renderAnimals(document.getElementById('animal-search')?.value || '');
            showAnimalDetail(newKey);
            alert('Animal saved!');
        }

        function deleteAnimal(key) {
            showConfirm('Delete Animal', `Delete "${currentRegistry.animals[key]?.name || key}"?`, async () => {
                delete currentRegistry.animals[key];
                await saveRegistry('animals');
                clearAnimalDetail();
            });
        }

        // ================== ITEMS ==================
        let selectedItemKey = null;

        function renderItems(filter = '') {
            const container = document.getElementById('items-list');
            const entries = Object.entries(currentRegistry.items || {});
            const filterLower = filter.toLowerCase();
            
            document.getElementById('item-count').textContent = entries.length;
            
            const filtered = entries.filter(([key, i]) => 
                i.name.toLowerCase().includes(filterLower) || 
                key.toLowerCase().includes(filterLower) ||
                (i.category && i.category.toLowerCase().includes(filterLower))
            );
            
            container.innerHTML = filtered.map(([key, i]) => {
                const sprite = i.asset || '';
                const categoryBadge = i.category ? `<span class="category-badge cat-${i.category}">${i.category}</span>` : '';
                return `
                <div class="master-item ${selectedItemKey === key ? 'selected' : ''}" data-key="${key}" onclick="selectItem('${key}')">
                    <div class="master-item-icon">
                        ${sprite ? `<img src="${ASSETS_BASE}/${sprite}" alt="">` : 'üéí'}
                    </div>
                    <div class="master-item-info">
                        <div class="master-item-name">${i.name} ${categoryBadge}</div>
                        <div class="master-item-key">${key}</div>
                    </div>
                </div>
            `}).join('');
        }

        function selectItem(key) {
            selectedItemKey = key;
            renderItems(document.getElementById('item-search')?.value || '');
            showItemDetail(key);
        }

        function showItemDetail(key) {
            const i = key ? currentRegistry.items[key] : { id: getNextId('items'), name: '', category: 'other' };
            const isNew = !key;
            const sprite = i.asset || '';
            
            const detail = document.getElementById('item-detail');
            detail.innerHTML = `
                <div class="detail-header">
                    <div class="detail-header-icon">
                        ${sprite ? `<img src="${ASSETS_BASE}/${sprite}" alt="">` : 'üéí'}
                    </div>
                    <div class="detail-header-info">
                        <h3>${isNew ? 'New Item' : i.name}</h3>
                        <span class="detail-key">${isNew ? 'Creating new item' : `Key: ${key} | ID: ${i.id}`}</span>
                    </div>
                </div>
                <form id="item-form" class="detail-form">
                    <div class="form-group">
                        <label>Key (internal name)</label>
                        <input type="text" name="key" value="${key || ''}" ${isNew ? '' : 'readonly'} required placeholder="e.g., SHARP_STONE">
                    </div>
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" name="name" value="${i.name || ''}" required placeholder="e.g., Sharp Stone">
                    </div>
                    <div class="form-group">
                        <label>ID (unique number)</label>
                        <input type="number" name="id" value="${i.id}" ${isNew ? '' : 'readonly'}>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select name="category">
                            <option value="tool" ${i.category === 'tool' ? 'selected' : ''}>üîß Tool</option>
                            <option value="material" ${i.category === 'material' ? 'selected' : ''}>üß± Material</option>
                            <option value="food" ${i.category === 'food' ? 'selected' : ''}>üçñ Food</option>
                            <option value="seed" ${i.category === 'seed' ? 'selected' : ''}>üå± Seed</option>
                            <option value="crop" ${i.category === 'crop' ? 'selected' : ''}>üåæ Crop</option>
                            <option value="weapon" ${i.category === 'weapon' ? 'selected' : ''}>‚öîÔ∏è Weapon</option>
                            <option value="ammo" ${i.category === 'ammo' ? 'selected' : ''}>üèπ Ammo</option>
                            <option value="container" ${i.category === 'container' ? 'selected' : ''}>üì¶ Container</option>
                            <option value="structure" ${i.category === 'structure' ? 'selected' : ''}>üè† Structure</option>
                            <option value="carcass" ${i.category === 'carcass' ? 'selected' : ''}>üíÄ Carcass</option>
                            <option value="other" ${i.category === 'other' ? 'selected' : ''}>üìé Other</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label>Description</label>
                        <input type="text" name="description" value="${i.description || ''}" placeholder="Short description of this item">
                    </div>
                    <div class="form-group full-width">
                        <label>Sprite / Asset</label>
                        ${getSpriteSelectHtml('asset', sprite, 'preview-item-detail')}
                    </div>
                    
                    <div class="form-section-title">Food Properties</div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="isEdible" id="item-edible" ${i.isEdible ? 'checked' : ''}>
                            <label for="item-edible">üçñ Is Edible</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Food Value</label>
                        <input type="number" name="foodValue" value="${i.foodValue || 0}" min="0">
                    </div>
                    
                    <div class="form-section-title">Weapon Properties</div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="isWeapon" id="item-weapon" ${i.isWeapon ? 'checked' : ''}>
                            <label for="item-weapon">‚öîÔ∏è Is Weapon</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Weapon Type</label>
                        <select name="weaponType">
                            <option value="" ${!i.weaponType ? 'selected' : ''}>None</option>
                            <option value="melee" ${i.weaponType === 'melee' ? 'selected' : ''}>Melee</option>
                            <option value="ranged" ${i.weaponType === 'ranged' ? 'selected' : ''}>Ranged</option>
                            <option value="throw" ${i.weaponType === 'throw' ? 'selected' : ''}>Throw</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Weapon Damage</label>
                        <input type="number" name="weaponDamage" value="${i.weaponDamage || 0}" min="0">
                    </div>
                    <div class="form-group">
                        <label>Ammo Type (for ranged)</label>
                        <input type="text" name="ammoType" value="${i.ammoType || ''}" placeholder="e.g., ARROW">
                    </div>
                    
                    <div class="form-section-title">Other Properties</div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="isContainer" id="item-container" ${i.isContainer ? 'checked' : ''}>
                            <label for="item-container">üì¶ Is Container</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Capacity</label>
                        <input type="number" name="capacity" value="${i.capacity || 0}" min="0">
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="isPlaceable" id="item-placeable" ${i.isPlaceable ? 'checked' : ''}>
                            <label for="item-placeable">üìç Is Placeable</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" name="isLarge" id="item-large" ${i.isLarge ? 'checked' : ''}>
                            <label for="item-large">üèîÔ∏è Is Large (2x size)</label>
                        </div>
                    </div>
                    
                    <div class="form-section-title">Growth Properties (for seeds/crops)</div>
                    <div class="form-group">
                        <label>Grows Into (item/resource key)</label>
                        <input type="text" name="growsInto" value="${i.growsInto || ''}" placeholder="e.g., WHEAT, BERRY_BUSH">
                    </div>
                    <div class="form-group">
                        <label>Growth Ticks</label>
                        <input type="number" name="growthTicks" value="${i.growthTicks || 0}" min="0" placeholder="Number of ticks to grow">
                    </div>
                </form>
                <div class="detail-actions">
                    <button class="btn btn-primary" onclick="saveItem('${key || ''}')">üíæ Save Item</button>
                    ${!isNew ? `<button class="btn btn-danger" onclick="deleteItem('${key}')">üóëÔ∏è Delete</button>` : ''}
                    <button class="btn" onclick="clearItemDetail()">Cancel</button>
                </div>
            `;
        }

        function clearItemDetail() {
            selectedItemKey = null;
            renderItems(document.getElementById('item-search')?.value || '');
            document.getElementById('item-detail').innerHTML = `
                <div class="detail-pane-empty">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z"/></svg>
                    <p>Select an item to view details</p>
                    <p style="font-size:0.85rem;">or click "+ New" to create one</p>
                </div>
            `;
        }

        async function saveItem(originalKey) {
            const form = document.getElementById('item-form');
            const fd = new FormData(form);
            const newKey = fd.get('key').trim().toUpperCase().replace(/\s+/g, '_');
            
            if (!newKey) {
                alert('Please enter a key');
                return;
            }
            
            if (originalKey && originalKey !== newKey) {
                delete currentRegistry.items[originalKey];
            }
            
            currentRegistry.items[newKey] = {
                id: parseInt(fd.get('id')),
                name: fd.get('name'),
                asset: fd.get('asset') || undefined,
                category: fd.get('category') || 'other',
                description: fd.get('description') || undefined,
                isEdible: fd.get('isEdible') === 'on' || undefined,
                foodValue: parseInt(fd.get('foodValue')) || undefined,
                isWeapon: fd.get('isWeapon') === 'on' || undefined,
                weaponType: fd.get('weaponType') || undefined,
                weaponDamage: parseInt(fd.get('weaponDamage')) || undefined,
                ammoType: fd.get('ammoType') || undefined,
                isContainer: fd.get('isContainer') === 'on' || undefined,
                capacity: parseInt(fd.get('capacity')) || undefined,
                isPlaceable: fd.get('isPlaceable') === 'on' || undefined,
                isLarge: fd.get('isLarge') === 'on' || undefined,
                growsInto: fd.get('growsInto') || undefined,
                growthTicks: parseInt(fd.get('growthTicks')) || undefined
            };
            
            // Clean up undefined values
            Object.keys(currentRegistry.items[newKey]).forEach(key => {
                if (currentRegistry.items[newKey][key] === undefined || 
                    currentRegistry.items[newKey][key] === false ||
                    currentRegistry.items[newKey][key] === 0) {
                    delete currentRegistry.items[newKey][key];
                }
            });
            // But always keep required fields
            currentRegistry.items[newKey].id = parseInt(fd.get('id'));
            currentRegistry.items[newKey].name = fd.get('name');
            currentRegistry.items[newKey].category = fd.get('category') || 'other';
            
            await saveRegistry('items');
            selectedItemKey = newKey;
            renderItems(document.getElementById('item-search')?.value || '');
            showItemDetail(newKey);
            alert('Item saved!');
        }

        function deleteItem(key) {
            showConfirm('Delete Item', `Delete "${currentRegistry.items[key]?.name || key}"?`, async () => {
                delete currentRegistry.items[key];
                await saveRegistry('items');
                clearItemDetail();
            });
        }

        async function saveRegistry(type) {
            await fetch(API_BASE + '/registry/' + type, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentRegistry[type])
            });
        }

        // ================== RECIPE MANAGER ==================
        
        let currentRecipeSlots = { tool: null, target: null, result: null };
        let editingRecipeIndex = -1;
        let draggedItem = null;

        // Get all available items (resources + items + animals)
        function getAllItems() {
            const items = [];
            
            // Add resources (natural spawning)
            for (const [key, r] of Object.entries(currentRegistry.resources || {})) {
                items.push({
                    key: key,
                    name: r.name,
                    type: 'resource',
                    icon: 'üå≤',
                    sprite: r.asset || r.sprite || ''
                });
            }
            
            // Add items (craftable/obtainable)
            for (const [key, i] of Object.entries(currentRegistry.items || {})) {
                items.push({
                    key: key,
                    name: i.name,
                    type: 'item',
                    icon: 'üéí',
                    sprite: i.asset || ''
                });
            }
            
            // Add animals
            for (const [key, a] of Object.entries(currentRegistry.animals || {})) {
                items.push({
                    key: key,
                    name: a.name,
                    type: 'animal',
                    icon: 'üêæ',
                    sprite: a.assets?.alive || ''
                });
            }
            
            return items.sort((a, b) => a.name.localeCompare(b.name));
        }

        // Render available items list
        function renderRecipeItems(filter = '') {
            const container = document.getElementById('recipe-item-list');
            const items = getAllItems();
            const filterLower = filter.toLowerCase();
            
            container.innerHTML = items
                .filter(item => 
                    item.name.toLowerCase().includes(filterLower) || 
                    item.key.toLowerCase().includes(filterLower)
                )
                .map(item => `
                    <div class="draggable-item" 
                         draggable="true" 
                         data-key="${item.key}" 
                         data-name="${item.name}"
                         data-type="${item.type}"
                         data-sprite="${item.sprite}">
                        ${item.sprite 
                            ? `<img src="${ASSETS_BASE}/${item.sprite}" alt="" style="width:24px;height:24px;object-fit:contain;">`
                            : `<span class="item-icon">${item.icon}</span>`}
                        <span class="item-name">${item.name}</span>
                        <span class="item-key">${item.key}</span>
                    </div>
                `).join('');
            
            // Add drag event listeners
            container.querySelectorAll('.draggable-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        // Render existing recipes list
        function renderRecipeList() {
            const container = document.getElementById('recipe-list');
            const recipes = currentRegistry.recipes || [];
            
            document.getElementById('recipe-count').textContent = recipes.length;
            
            if (recipes.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">No recipes yet. Create one above!</div>';
                return;
            }
            
            container.innerHTML = recipes.map((recipe, index) => `
                <div class="recipe-list-item ${editingRecipeIndex === index ? 'selected' : ''}" data-index="${index}">
                    <div class="recipe-list-item-info">
                        <div class="recipe-list-item-name">${recipe.name || recipe.id}</div>
                        <div class="recipe-list-item-formula">
                            ${recipe.tool === null ? '‚úã' : recipe.tool} + ${recipe.target} ‚Üí ${recipe.result}${recipe.targetBecomesType ? ` (${recipe.target}‚Üí${recipe.targetBecomesType})` : ''}${recipe.targetPersists ? ' üî•' : ''}
                        </div>
                    </div>
                    <div class="recipe-list-item-actions">
                        <button class="btn btn-sm btn-primary" onclick="editRecipe(${index})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRecipe(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Drag & Drop handlers
        function handleDragStart(e) {
            draggedItem = {
                key: e.target.dataset.key,
                name: e.target.dataset.name,
                type: e.target.dataset.type,
                sprite: e.target.dataset.sprite || ''
            };
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'copy';
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedItem = null;
        }

        function handleSlotDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleSlotDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleSlotDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            if (!draggedItem) return;
            
            const slotType = e.currentTarget.dataset.slot;
            setSlot(slotType, draggedItem.key, draggedItem.name, draggedItem.sprite);
        }

        // Set slot content
        function setSlot(slotType, key, name, sprite = '') {
            currentRecipeSlots[slotType] = key;
            
            const slot = document.getElementById('slot-' + slotType);
            const content = slot.querySelector('.recipe-slot-content');
            
            slot.classList.add('filled');
            content.innerHTML = `
                ${sprite ? `<img src="${ASSETS_BASE}/${sprite}" alt="" style="width:32px;height:32px;object-fit:contain;margin-bottom:4px;">` : ''}
                <div class="slot-name">${name}</div>
                <div class="slot-key">${key}</div>
            `;
        }

        // Clear a slot
        function clearSlot(slotType) {
            currentRecipeSlots[slotType] = null;
            
            const slot = document.getElementById('slot-' + slotType);
            const content = slot.querySelector('.recipe-slot-content');
            
            slot.classList.remove('filled');
            content.innerHTML = '<span class="empty-slot-text">Drop here</span>';
        }

        // Clear all form
        function clearRecipeForm() {
            clearSlot('tool');
            clearSlot('target');
            clearSlot('result');
            document.getElementById('recipe-id').value = '';
            document.getElementById('recipe-name').value = '';
            document.getElementById('recipe-description').value = '';
            document.getElementById('recipe-target-becomes').value = '';
            document.getElementById('recipe-target-persists').checked = false;
            document.getElementById('recipe-bare-hands').checked = false;
            editingRecipeIndex = -1;
            renderRecipeList();
        }

        // Edit existing recipe
        function editRecipe(index) {
            const recipe = currentRegistry.recipes[index];
            if (!recipe) return;
            
            editingRecipeIndex = index;
            
            // Find item names
            const items = getAllItems();
            const toolItem = items.find(i => i.key === recipe.tool);
            const targetItem = items.find(i => i.key === recipe.target);
            const resultItem = items.find(i => i.key === recipe.result);
            
            // Handle bare hands (null tool)
            const isBareHands = recipe.tool === null;
            document.getElementById('recipe-bare-hands').checked = isBareHands;
            
            if (isBareHands) {
                clearSlot('tool');
            } else if (toolItem) {
                setSlot('tool', recipe.tool, toolItem.name, toolItem.sprite);
            } else {
                setSlot('tool', recipe.tool, recipe.tool, '');
            }
            
            if (targetItem) setSlot('target', recipe.target, targetItem.name, targetItem.sprite);
            else setSlot('target', recipe.target, recipe.target, '');
            
            if (resultItem) setSlot('result', recipe.result, resultItem.name, resultItem.sprite);
            else setSlot('result', recipe.result, recipe.result, '');
            
            // Set form fields
            document.getElementById('recipe-id').value = recipe.id || '';
            document.getElementById('recipe-name').value = recipe.name || '';
            document.getElementById('recipe-description').value = recipe.description || '';
            document.getElementById('recipe-target-becomes').value = recipe.targetBecomesType || '';
            document.getElementById('recipe-target-persists').checked = recipe.targetPersists || false;
            
            renderRecipeList();
        }

        // Delete recipe
        function deleteRecipe(index) {
            const recipe = currentRegistry.recipes[index];
            showConfirm('Delete Recipe', `Delete recipe "${recipe.name || recipe.id}"?`, async () => {
                currentRegistry.recipes.splice(index, 1);
                await saveRegistry('recipes');
                if (editingRecipeIndex === index) {
                    clearRecipeForm();
                } else if (editingRecipeIndex > index) {
                    editingRecipeIndex--;
                }
                renderRecipeList();
            });
        }

        // Save recipe
        async function saveRecipe() {
            const id = document.getElementById('recipe-id').value.trim();
            const name = document.getElementById('recipe-name').value.trim();
            const description = document.getElementById('recipe-description').value.trim();
            const targetBecomesType = document.getElementById('recipe-target-becomes').value.trim();
            const isBareHands = document.getElementById('recipe-bare-hands').checked;
            const targetPersists = document.getElementById('recipe-target-persists').checked;
            
            // Tool can be null for bare hands recipes
            if (!isBareHands && !currentRecipeSlots.tool) {
                alert('Please fill the Tool slot or check "Bare Hands"');
                return;
            }
            
            if (!currentRecipeSlots.target || !currentRecipeSlots.result) {
                alert('Please fill Target and Result slots');
                return;
            }
            
            if (!id) {
                alert('Please enter a Recipe ID');
                return;
            }
            
            const recipe = {
                id: id,
                name: name || id,
                tool: isBareHands ? null : currentRecipeSlots.tool,
                target: currentRecipeSlots.target,
                result: currentRecipeSlots.result,
                description: description
            };
            
            // Only add targetBecomesType if specified
            if (targetBecomesType) {
                recipe.targetBecomesType = targetBecomesType;
            }
            
            // Only add targetPersists if true
            if (targetPersists) {
                recipe.targetPersists = true;
            }
            
            if (!currentRegistry.recipes) {
                currentRegistry.recipes = [];
            }
            
            if (editingRecipeIndex >= 0) {
                // Update existing
                currentRegistry.recipes[editingRecipeIndex] = recipe;
            } else {
                // Check for duplicate ID
                const existingIndex = currentRegistry.recipes.findIndex(r => r.id === id);
                if (existingIndex >= 0) {
                    if (!confirm(`Recipe with ID "${id}" already exists. Replace it?`)) {
                        return;
                    }
                    currentRegistry.recipes[existingIndex] = recipe;
                } else {
                    currentRegistry.recipes.push(recipe);
                }
            }
            
            await saveRegistry('recipes');
            clearRecipeForm();
            renderRecipeList();
            alert('Recipe saved!');
        }

        // Initialize recipe drag/drop slots
        function initRecipeSlots() {
            ['tool', 'target', 'result'].forEach(slotType => {
                const slot = document.getElementById('slot-' + slotType);
                if (slot) {
                    slot.addEventListener('dragover', handleSlotDragOver);
                    slot.addEventListener('dragleave', handleSlotDragLeave);
                    slot.addEventListener('drop', handleSlotDrop);
                }
            });
            
            // Search filter
            document.getElementById('recipe-item-search')?.addEventListener('input', (e) => {
                renderRecipeItems(e.target.value);
            });
            
            // Save button
            document.getElementById('btn-save-recipe')?.addEventListener('click', saveRecipe);
            
            // Clear button
            document.getElementById('btn-clear-recipe')?.addEventListener('click', clearRecipeForm);
        }

        // ================== END RECIPE MANAGER ==================

        // Add buttons - Resources
        document.getElementById('btn-add-resource')?.addEventListener('click', () => {
            selectedResourceKey = null;
            showResourceDetail(null);
        });
        document.getElementById('resource-search')?.addEventListener('input', (e) => {
            renderResources(e.target.value);
        });

        // Add buttons - Items
        document.getElementById('btn-add-item')?.addEventListener('click', () => {
            selectedItemKey = null;
            showItemDetail(null);
        });
        document.getElementById('item-search')?.addEventListener('input', (e) => {
            renderItems(e.target.value);
        });

        // Add buttons - Animals
        document.getElementById('btn-add-animal')?.addEventListener('click', () => {
            selectedAnimalKey = null;
            showAnimalDetail(null);
        });
        document.getElementById('animal-search')?.addEventListener('input', (e) => {
            renderAnimals(e.target.value);
        });

        // Helpers
        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function getNextId(type) {
            const items = Object.values(currentRegistry[type] || {});
            return items.length ? Math.max(...items.map(i => i.id)) + 1 : 100;
        }

        // Init
        async function init() {
            await loadConfig();
            await loadSprites();
            await loadRegistry();
            await loadModules();
            await loadStats();
            initRecipeSlots();
            
            // Refresh stats every 5 seconds
            statsInterval = setInterval(loadStats, 5000);
        }

        init();

        // --- MAP RENDERING ---
        const mapCanvas = document.getElementById('world-map-canvas');
        const mapCtx = mapCanvas.getContext('2d');
        const mapContainer = document.getElementById('map-container');
        const mapLoading = document.getElementById('map-loading');
        const mapStatus = document.getElementById('map-status');

        const BIOME_COLORS = {
            grassland: '#4CAF50',
            forest: '#2E7D32',
            desert: '#D4A54A',
            swamp: '#5D7A54',
            water: '#2196F3'
        };

        const DEFAULT_PARAMS = {
            noiseScale: 80,
            noiseOctaves: 4,
            noisePersistence: 0.5,
            waterThreshold: 0.28,
            waterPocketThreshold: 0.32,
            waterPocketChance: 0.35,
            edgeBiasStart: 0.80,
            edgeBiasStrength: 3,
            spawnProtectionRadius: 0,
            swampElevation: 0.35,
            swampMoisture: 0.55,
            forestMoisture: 0.60,
            desertMoisture: 0.35
        };

        // Setup slider listeners
        function setupSliders() {
            const sliders = ['noiseScale', 'waterThreshold', 'edgeBiasStart', 'edgeBiasStrength', 'spawnProtectionRadius', 'forestMoisture'];
            sliders.forEach(param => {
                const slider = document.getElementById(`slider-${param}`);
                const valueDisplay = document.getElementById(`val-${param}`);
                if (slider && valueDisplay) {
                    slider.addEventListener('input', () => {
                        valueDisplay.textContent = slider.value;
                    });
                }
            });
        }

        async function loadWorldParams() {
            try {
                const res = await fetch(API_BASE + '/world/params');
                const params = await res.json();
                
                // Update sliders with current values
                for (const key in params) {
                    const slider = document.getElementById(`slider-${key}`);
                    const valueDisplay = document.getElementById(`val-${key}`);
                    if (slider && valueDisplay) {
                        slider.value = params[key];
                        valueDisplay.textContent = params[key];
                    }
                }
            } catch (err) {
                console.error('Failed to load world params:', err);
            }
        }

        async function applyWorldParams() {
            const params = {
                noiseScale: parseFloat(document.getElementById('slider-noiseScale').value),
                waterThreshold: parseFloat(document.getElementById('slider-waterThreshold').value),
                edgeBiasStart: parseFloat(document.getElementById('slider-edgeBiasStart').value),
                edgeBiasStrength: parseFloat(document.getElementById('slider-edgeBiasStrength').value),
                spawnProtectionRadius: parseFloat(document.getElementById('slider-spawnProtectionRadius').value),
                forestMoisture: parseFloat(document.getElementById('slider-forestMoisture').value)
            };

            mapLoading.style.display = 'flex';
            mapStatus.textContent = 'Regenerating world...';
            try {
                await fetch(API_BASE + '/world/params', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params)
                });
                mapStatus.textContent = 'World regenerated!';
                await loadFullMap();
            } catch (err) {
                console.error('Failed to apply params:', err);
                mapStatus.textContent = 'Error applying parameters';
            }
        }

        function resetWorldParams() {
            for (const key in DEFAULT_PARAMS) {
                const slider = document.getElementById(`slider-${key}`);
                const valueDisplay = document.getElementById(`val-${key}`);
                if (slider && valueDisplay) {
                    slider.value = DEFAULT_PARAMS[key];
                    valueDisplay.textContent = DEFAULT_PARAMS[key];
                }
            }
        }

        document.getElementById('btn-apply-params').addEventListener('click', applyWorldParams);
        document.getElementById('btn-reset-params').addEventListener('click', resetWorldParams);

        async function saveWorldNow() {
            const saveStatus = document.getElementById('save-status');
            saveStatus.textContent = 'Saving world...';
            saveStatus.style.color = '#ffc107';
            try {
                const res = await fetch(API_BASE + '/world/save', { method: 'POST' });
                const result = await res.json();
                saveStatus.textContent = result.success ? '‚úì World saved successfully' : '‚úó Failed to save world';
                saveStatus.style.color = result.success ? '#4caf50' : '#f44336';
                setTimeout(() => { saveStatus.textContent = ''; }, 3000);
            } catch (err) {
                console.error('Failed to save world:', err);
                saveStatus.textContent = '‚úó Error saving world';
                saveStatus.style.color = '#f44336';
            }
        }

        document.getElementById('btn-save-world').addEventListener('click', saveWorldNow);

        async function loadFullMap() {
            mapLoading.style.display = 'flex';
            mapStatus.textContent = 'Fetching map data...';
            try {
                const res = await fetch(API_BASE + '/world/full');
                const world = await res.json();
                renderFullMap(world);
                mapStatus.textContent = `Map rendered at ${new Date().toLocaleTimeString()}`;
            } catch (err) {
                console.error('Failed to load map:', err);
                mapStatus.textContent = 'Error loading map';
            } finally {
                mapLoading.style.display = 'none';
            }
        }

        function renderFullMap(world) {
            const tiles = world.tiles;
            if (!tiles || tiles.length === 0) return;

            const height = tiles.length;
            const width = tiles[0].length;
            
            // Set canvas size (proportional to world size)
            const tileSize = Math.max(1, Math.floor(600 / height));
            mapCanvas.width = width * tileSize;
            mapCanvas.height = height * tileSize;

            // Draw tiles
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const biome = tiles[y][x];
                    mapCtx.fillStyle = BIOME_COLORS[biome] || '#000';
                    mapCtx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
                }
            }

            // Draw objects as dots
            const objects = world.objects || {};
            for (const key in objects) {
                const [ox, oy] = key.split(',').map(Number);
                const type = objects[key];
                
                // Draw resources (dots)
                mapCtx.fillStyle = 'rgba(255, 255, 255, 0.4)';
                mapCtx.fillRect(ox * tileSize, oy * tileSize, Math.max(1, tileSize/2), Math.max(1, tileSize/2));
            }
        }

        document.getElementById('btn-refresh-map').addEventListener('click', loadFullMap);

        // Load map when switching to world page
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.dataset.page === 'world') {
                    // Slight delay to ensure page is visible for canvas sizing
                    setTimeout(() => {
                        loadWorldParams();
                        loadFullMap();
                    }, 100);
                }
            });
        });

        // --- Player Management ---

        async function loadPlayers() {
            try {
                const res = await fetch(API_BASE + '/players');
                const players = await res.json();
                renderPlayersTable(players);
            } catch (err) {
                console.error('Failed to load players:', err);
            }
        }

        function renderPlayersTable(players) {
            const tbody = document.getElementById('players-table-body');
            document.getElementById('player-count-badge').textContent = players.length;
            
            if (players.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #888;">No players online</td></tr>';
                return;
            }
            
            tbody.innerHTML = players.map(p => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px;">
                        <div style="font-weight: bold; color: #fff;">${p.name || 'Unnamed'}</div>
                        <div style="font-size: 0.8em; color: #888; font-family: monospace;">${p.id}</div>
                    </td>
                    <td style="padding: 10px; font-family: monospace;">${p.ip}</td>
                    <td style="padding: 10px;">${p.age ? p.age.toFixed(1) : '?'} y/o</td>
                    <td style="padding: 10px;">Gen ${p.generation || 1}</td>
                    <td style="padding: 10px;">
                        <button class="btn btn-sm btn-warning" onclick="kickPlayer('${p.id}')" style="margin-right: 5px;">Kick</button>
                        <button class="btn btn-sm btn-danger" onclick="banPlayer('${p.id}', '${p.ip}')">Ban IP</button>
                    </td>
                </tr>
            `).join('');
        }

        async function kickPlayer(id) {
            if (!confirm('Are you sure you want to kick this player?')) return;
            try {
                const res = await fetch(API_BASE + '/players/kick', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                if (res.ok) {
                    showToast('Player kicked', 'success');
                    loadPlayers();
                } else {
                    showToast('Failed to kick player', 'error'); // showToast is likely not defined, but I'll use simple alert or console if not available. Wait, I should check if showToast exists.
                }
            } catch(e) {
                console.error(e);
                alert('Error kicking player');
            }
        }
        
        // Helper toast function since I'm not sure if it exists in the codebase, 
        // but based on typical patterns it might. I'll define a simple one if needed or just use consistent UI.
        // Actually, looking at the code I read, I don't see a showToast function. 
        // I'll check the top of the script tag later. For now I'll implement a simple one or use console.

        async function banPlayer(id, ip) {
            if (!confirm(`Are you sure you want to BAN IP ${ip}? This will disconnect the player and prevent reconnection.`)) return;
            try {
                const res = await fetch(API_BASE + '/players/ban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                if (res.ok) {
                    loadPlayers();
                    alert('Player banned successfully.');
                } else {
                    alert('Failed to ban player.');
                }
            } catch(e) {
                console.error(e);
                alert('Error banning player');
            }
        }

        // Expose to window for onclick handlers
        window.kickPlayer = kickPlayer;
        window.banPlayer = banPlayer;

        document.getElementById('btn-refresh-players').addEventListener('click', loadPlayers);

        // --- Banned IPs Management ---

        async function loadBans() {
             try {
                const res = await fetch(API_BASE + '/bans');
                const bans = await res.json();
                renderBansTable(bans);
            } catch (err) {
                console.error('Failed to load bans:', err);
            }
        }

        function renderBansTable(bans) {
            const tbody = document.getElementById('bans-table-body');
            document.getElementById('ban-count-badge').textContent = bans.length;

             if (bans.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2" style="padding: 20px; text-align: center; color: #888;">No banned IPs</td></tr>';
                return;
            }

            tbody.innerHTML = bans.map(ip => `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 10px; font-family: monospace;">${ip}</td>
                    <td style="padding: 10px;">
                        <button class="btn btn-sm btn-success" onclick="unbanIp('${ip}')">Unban</button>
                    </td>
                </tr>
            `).join('');
        }

        async function unbanIp(ip) {
            if (!confirm(`Are you sure you want to UNBAN IP ${ip}?`)) return;
             try {
                const res = await fetch(API_BASE + '/bans/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ip: ip })
                });
                if (res.ok) {
                    loadBans();
                    alert('IP unbanned successfully.');
                } else {
                    alert('Failed to unban IP.');
                }
            } catch(e) {
                console.error(e);
                alert('Error unbanning IP');
            }
        }
        
        window.unbanIp = unbanIp;
        document.getElementById('btn-refresh-bans').addEventListener('click', loadBans);


        // Auto-refresh players when looking at the tab
        let playerRefreshInterval = null;
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (item.dataset.page === 'players') {
                    loadPlayers();
                    loadBans();
                    if (!playerRefreshInterval) {
                        playerRefreshInterval = setInterval(loadPlayers, 5000);
                    }
                } else {
                    // Start interval should clear if we leave the page
                    if (playerRefreshInterval && item.dataset.page !== 'players') {
                         clearInterval(playerRefreshInterval);
                         playerRefreshInterval = null;
                    }
                }
            });
        });

        setupSliders();
    </script>
</body>
</html>
