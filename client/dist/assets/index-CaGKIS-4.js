(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const R=Object.create(null);R.open="0";R.close="1";R.ping="2";R.pong="3";R.message="4";R.upgrade="5";R.noop="6";const H=Object.create(null);Object.keys(R).forEach(i=>{H[R[i]]=i});const X={type:"error",data:"parser error"},wt=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",xt=typeof ArrayBuffer=="function",kt=i=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(i):i&&i.buffer instanceof ArrayBuffer,nt=({type:i,data:t},e,s)=>wt&&t instanceof Blob?e?s(t):ft(t,s):xt&&(t instanceof ArrayBuffer||kt(t))?e?s(t):ft(new Blob([t]),s):s(R[i]+(t||"")),ft=(i,t)=>{const e=new FileReader;return e.onload=function(){const s=e.result.split(",")[1];t("b"+(s||""))},e.readAsDataURL(i)};function dt(i){return i instanceof Uint8Array?i:i instanceof ArrayBuffer?new Uint8Array(i):new Uint8Array(i.buffer,i.byteOffset,i.byteLength)}let z;function It(i,t){if(wt&&i.data instanceof Blob)return i.data.arrayBuffer().then(dt).then(t);if(xt&&(i.data instanceof ArrayBuffer||kt(i.data)))return t(dt(i.data));nt(i,!1,e=>{z||(z=new TextEncoder),t(z.encode(e))})}const pt="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",M=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let i=0;i<pt.length;i++)M[pt.charCodeAt(i)]=i;const Lt=i=>{let t=i.length*.75,e=i.length,s,n=0,r,o,c,a;i[i.length-1]==="="&&(t--,i[i.length-2]==="="&&t--);const h=new ArrayBuffer(t),l=new Uint8Array(h);for(s=0;s<e;s+=4)r=M[i.charCodeAt(s)],o=M[i.charCodeAt(s+1)],c=M[i.charCodeAt(s+2)],a=M[i.charCodeAt(s+3)],l[n++]=r<<2|o>>4,l[n++]=(o&15)<<4|c>>2,l[n++]=(c&3)<<6|a&63;return h},qt=typeof ArrayBuffer=="function",rt=(i,t)=>{if(typeof i!="string")return{type:"message",data:vt(i,t)};const e=i.charAt(0);return e==="b"?{type:"message",data:jt(i.substring(1),t)}:H[e]?i.length>1?{type:H[e],data:i.substring(1)}:{type:H[e]}:X},jt=(i,t)=>{if(qt){const e=Lt(i);return vt(e,t)}else return{base64:!0,data:i}},vt=(i,t)=>t==="blob"?i instanceof Blob?i:new Blob([i]):i instanceof ArrayBuffer?i:i.buffer,_t="",Ht=(i,t)=>{const e=i.length,s=new Array(e);let n=0;i.forEach((r,o)=>{nt(r,!1,c=>{s[o]=c,++n===e&&t(s.join(_t))})})},Ut=(i,t)=>{const e=i.split(_t),s=[];for(let n=0;n<e.length;n++){const r=rt(e[n],t);if(s.push(r),r.type==="error")break}return s};function Ft(){return new TransformStream({transform(i,t){It(i,e=>{const s=e.length;let n;if(s<126)n=new Uint8Array(1),new DataView(n.buffer).setUint8(0,s);else if(s<65536){n=new Uint8Array(3);const r=new DataView(n.buffer);r.setUint8(0,126),r.setUint16(1,s)}else{n=new Uint8Array(9);const r=new DataView(n.buffer);r.setUint8(0,127),r.setBigUint64(1,BigInt(s))}i.data&&typeof i.data!="string"&&(n[0]|=128),t.enqueue(n),t.enqueue(e)})}})}let J;function q(i){return i.reduce((t,e)=>t+e.length,0)}function j(i,t){if(i[0].length===t)return i.shift();const e=new Uint8Array(t);let s=0;for(let n=0;n<t;n++)e[n]=i[0][s++],s===i[0].length&&(i.shift(),s=0);return i.length&&s<i[0].length&&(i[0]=i[0].slice(s)),e}function Vt(i,t){J||(J=new TextDecoder);const e=[];let s=0,n=-1,r=!1;return new TransformStream({transform(o,c){for(e.push(o);;){if(s===0){if(q(e)<1)break;const a=j(e,1);r=(a[0]&128)===128,n=a[0]&127,n<126?s=3:n===126?s=1:s=2}else if(s===1){if(q(e)<2)break;const a=j(e,2);n=new DataView(a.buffer,a.byteOffset,a.length).getUint16(0),s=3}else if(s===2){if(q(e)<8)break;const a=j(e,8),h=new DataView(a.buffer,a.byteOffset,a.length),l=h.getUint32(0);if(l>Math.pow(2,21)-1){c.enqueue(X);break}n=l*Math.pow(2,32)+h.getUint32(4),s=3}else{if(q(e)<n)break;const a=j(e,n);c.enqueue(rt(r?a:J.decode(a),t)),s=0}if(n===0||n>i){c.enqueue(X);break}}}})}const Ct=4;function m(i){if(i)return $t(i)}function $t(i){for(var t in m.prototype)i[t]=m.prototype[t];return i}m.prototype.on=m.prototype.addEventListener=function(i,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+i]=this._callbacks["$"+i]||[]).push(t),this};m.prototype.once=function(i,t){function e(){this.off(i,e),t.apply(this,arguments)}return e.fn=t,this.on(i,e),this};m.prototype.off=m.prototype.removeListener=m.prototype.removeAllListeners=m.prototype.removeEventListener=function(i,t){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var e=this._callbacks["$"+i];if(!e)return this;if(arguments.length==1)return delete this._callbacks["$"+i],this;for(var s,n=0;n<e.length;n++)if(s=e[n],s===t||s.fn===t){e.splice(n,1);break}return e.length===0&&delete this._callbacks["$"+i],this};m.prototype.emit=function(i){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),e=this._callbacks["$"+i],s=1;s<arguments.length;s++)t[s-1]=arguments[s];if(e){e=e.slice(0);for(var s=0,n=e.length;s<n;++s)e[s].apply(this,t)}return this};m.prototype.emitReserved=m.prototype.emit;m.prototype.listeners=function(i){return this._callbacks=this._callbacks||{},this._callbacks["$"+i]||[]};m.prototype.hasListeners=function(i){return!!this.listeners(i).length};const K=typeof Promise=="function"&&typeof Promise.resolve=="function"?t=>Promise.resolve().then(t):(t,e)=>e(t,0),k=typeof self<"u"?self:typeof window<"u"?window:Function("return this")(),Wt="arraybuffer";function Rt(i,...t){return t.reduce((e,s)=>(i.hasOwnProperty(s)&&(e[s]=i[s]),e),{})}const Kt=k.setTimeout,Gt=k.clearTimeout;function G(i,t){t.useNativeTimers?(i.setTimeoutFn=Kt.bind(k),i.clearTimeoutFn=Gt.bind(k)):(i.setTimeoutFn=k.setTimeout.bind(k),i.clearTimeoutFn=k.clearTimeout.bind(k))}const Yt=1.33;function zt(i){return typeof i=="string"?Jt(i):Math.ceil((i.byteLength||i.size)*Yt)}function Jt(i){let t=0,e=0;for(let s=0,n=i.length;s<n;s++)t=i.charCodeAt(s),t<128?e+=1:t<2048?e+=2:t<55296||t>=57344?e+=3:(s++,e+=4);return e}function Bt(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}function Qt(i){let t="";for(let e in i)i.hasOwnProperty(e)&&(t.length&&(t+="&"),t+=encodeURIComponent(e)+"="+encodeURIComponent(i[e]));return t}function Xt(i){let t={},e=i.split("&");for(let s=0,n=e.length;s<n;s++){let r=e[s].split("=");t[decodeURIComponent(r[0])]=decodeURIComponent(r[1])}return t}class Zt extends Error{constructor(t,e,s){super(t),this.description=e,this.context=s,this.type="TransportError"}}class ot extends m{constructor(t){super(),this.writable=!1,G(this,t),this.opts=t,this.query=t.query,this.socket=t.socket,this.supportsBinary=!t.forceBase64}onError(t,e,s){return super.emitReserved("error",new Zt(t,e,s)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(t){this.readyState==="open"&&this.write(t)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(t){const e=rt(t,this.socket.binaryType);this.onPacket(e)}onPacket(t){super.emitReserved("packet",t)}onClose(t){this.readyState="closed",super.emitReserved("close",t)}pause(t){}createUri(t,e={}){return t+"://"+this._hostname()+this._port()+this.opts.path+this._query(e)}_hostname(){const t=this.opts.hostname;return t.indexOf(":")===-1?t:"["+t+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(this.opts.port)!==443||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(t){const e=Qt(t);return e.length?"?"+e:""}}class te extends ot{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(t){this.readyState="pausing";const e=()=>{this.readyState="paused",t()};if(this._polling||!this.writable){let s=0;this._polling&&(s++,this.once("pollComplete",function(){--s||e()})),this.writable||(s++,this.once("drain",function(){--s||e()}))}else e()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(t){const e=s=>{if(this.readyState==="opening"&&s.type==="open"&&this.onOpen(),s.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(s)};Ut(t,this.socket.binaryType).forEach(e),this.readyState!=="closed"&&(this._polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this._poll())}doClose(){const t=()=>{this.write([{type:"close"}])};this.readyState==="open"?t():this.once("open",t)}write(t){this.writable=!1,Ht(t,e=>{this.doWrite(e,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){const t=this.opts.secure?"https":"http",e=this.query||{};return this.opts.timestampRequests!==!1&&(e[this.opts.timestampParam]=Bt()),!this.supportsBinary&&!e.sid&&(e.b64=1),this.createUri(t,e)}}let Tt=!1;try{Tt=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}const ee=Tt;function se(){}class ie extends te{constructor(t){if(super(t),typeof location<"u"){const e=location.protocol==="https:";let s=location.port;s||(s=e?"443":"80"),this.xd=typeof location<"u"&&t.hostname!==location.hostname||s!==t.port}}doWrite(t,e){const s=this.request({method:"POST",data:t});s.on("success",e),s.on("error",(n,r)=>{this.onError("xhr post error",n,r)})}doPoll(){const t=this.request();t.on("data",this.onData.bind(this)),t.on("error",(e,s)=>{this.onError("xhr poll error",e,s)}),this.pollXhr=t}}class C extends m{constructor(t,e,s){super(),this.createRequest=t,G(this,s),this._opts=s,this._method=s.method||"GET",this._uri=e,this._data=s.data!==void 0?s.data:null,this._create()}_create(){var t;const e=Rt(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this._opts.xd;const s=this._xhr=this.createRequest(e);try{s.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(!0);for(let n in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(n)&&s.setRequestHeader(n,this._opts.extraHeaders[n])}}catch{}if(this._method==="POST")try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{s.setRequestHeader("Accept","*/*")}catch{}(t=this._opts.cookieJar)===null||t===void 0||t.addCookies(s),"withCredentials"in s&&(s.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(s.timeout=this._opts.requestTimeout),s.onreadystatechange=()=>{var n;s.readyState===3&&((n=this._opts.cookieJar)===null||n===void 0||n.parseCookies(s.getResponseHeader("set-cookie"))),s.readyState===4&&(s.status===200||s.status===1223?this._onLoad():this.setTimeoutFn(()=>{this._onError(typeof s.status=="number"?s.status:0)},0))},s.send(this._data)}catch(n){this.setTimeoutFn(()=>{this._onError(n)},0);return}typeof document<"u"&&(this._index=C.requestsCount++,C.requests[this._index]=this)}_onError(t){this.emitReserved("error",t,this._xhr),this._cleanup(!0)}_cleanup(t){if(!(typeof this._xhr>"u"||this._xhr===null)){if(this._xhr.onreadystatechange=se,t)try{this._xhr.abort()}catch{}typeof document<"u"&&delete C.requests[this._index],this._xhr=null}}_onLoad(){const t=this._xhr.responseText;t!==null&&(this.emitReserved("data",t),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}C.requestsCount=0;C.requests={};if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",gt);else if(typeof addEventListener=="function"){const i="onpagehide"in k?"pagehide":"unload";addEventListener(i,gt,!1)}}function gt(){for(let i in C.requests)C.requests.hasOwnProperty(i)&&C.requests[i].abort()}const ne=(function(){const i=At({xdomain:!1});return i&&i.responseType!==null})();class re extends ie{constructor(t){super(t);const e=t&&t.forceBase64;this.supportsBinary=ne&&!e}request(t={}){return Object.assign(t,{xd:this.xd},this.opts),new C(At,this.uri(),t)}}function At(i){const t=i.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!t||ee))return new XMLHttpRequest}catch{}if(!t)try{return new k[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}const Et=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative";class oe extends ot{get name(){return"websocket"}doOpen(){const t=this.uri(),e=this.opts.protocols,s=Et?{}:Rt(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(s.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(t,e,s)}catch(n){return this.emitReserved("error",n)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=t=>this.onClose({description:"websocket connection closed",context:t}),this.ws.onmessage=t=>this.onData(t.data),this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const s=t[e],n=e===t.length-1;nt(s,this.supportsBinary,r=>{try{this.doWrite(s,r)}catch{}n&&K(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const t=this.opts.secure?"wss":"ws",e=this.query||{};return this.opts.timestampRequests&&(e[this.opts.timestampParam]=Bt()),this.supportsBinary||(e.b64=1),this.createUri(t,e)}}const Q=k.WebSocket||k.MozWebSocket;class ae extends oe{createSocket(t,e,s){return Et?new Q(t,e,s):e?new Q(t,e):new Q(t)}doWrite(t,e){this.ws.send(e)}}class ce extends ot{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(t){return this.emitReserved("error",t)}this._transport.closed.then(()=>{this.onClose()}).catch(t=>{this.onError("webtransport error",t)}),this._transport.ready.then(()=>{this._transport.createBidirectionalStream().then(t=>{const e=Vt(Number.MAX_SAFE_INTEGER,this.socket.binaryType),s=t.readable.pipeThrough(e).getReader(),n=Ft();n.readable.pipeTo(t.writable),this._writer=n.writable.getWriter();const r=()=>{s.read().then(({done:c,value:a})=>{c||(this.onPacket(a),r())}).catch(c=>{})};r();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this._writer.write(o).then(()=>this.onOpen())})})}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const s=t[e],n=e===t.length-1;this._writer.write(s).then(()=>{n&&K(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var t;(t=this._transport)===null||t===void 0||t.close()}}const he={websocket:ae,webtransport:ce,polling:re},le=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,ue=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Z(i){if(i.length>8e3)throw"URI too long";const t=i,e=i.indexOf("["),s=i.indexOf("]");e!=-1&&s!=-1&&(i=i.substring(0,e)+i.substring(e,s).replace(/:/g,";")+i.substring(s,i.length));let n=le.exec(i||""),r={},o=14;for(;o--;)r[ue[o]]=n[o]||"";return e!=-1&&s!=-1&&(r.source=t,r.host=r.host.substring(1,r.host.length-1).replace(/;/g,":"),r.authority=r.authority.replace("[","").replace("]","").replace(/;/g,":"),r.ipv6uri=!0),r.pathNames=fe(r,r.path),r.queryKey=de(r,r.query),r}function fe(i,t){const e=/\/{2,9}/g,s=t.replace(e,"/").split("/");return(t.slice(0,1)=="/"||t.length===0)&&s.splice(0,1),t.slice(-1)=="/"&&s.splice(s.length-1,1),s}function de(i,t){const e={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(s,n,r){n&&(e[n]=r)}),e}const tt=typeof addEventListener=="function"&&typeof removeEventListener=="function",U=[];tt&&addEventListener("offline",()=>{U.forEach(i=>i())},!1);class A extends m{constructor(t,e){if(super(),this.binaryType=Wt,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,t&&typeof t=="object"&&(e=t,t=null),t){const s=Z(t);e.hostname=s.host,e.secure=s.protocol==="https"||s.protocol==="wss",e.port=s.port,s.query&&(e.query=s.query)}else e.host&&(e.hostname=Z(e.host).host);G(this,e),this.secure=e.secure!=null?e.secure:typeof location<"u"&&location.protocol==="https:",e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.hostname=e.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=e.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},e.transports.forEach(s=>{const n=s.prototype.name;this.transports.push(n),this._transportsByName[n]=s}),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},e),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=Xt(this.opts.query)),tt&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},U.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(t){const e=Object.assign({},this.opts.query);e.EIO=Ct,e.transport=t,this.id&&(e.sid=this.id);const s=Object.assign({},this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[t]);return new this._transportsByName[t](s)}_open(){if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}const t=this.opts.rememberUpgrade&&A.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1?"websocket":this.transports[0];this.readyState="opening";const e=this.createTransport(t);e.open(),this.setTransport(e)}setTransport(t){this.transport&&this.transport.removeAllListeners(),this.transport=t,t.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",e=>this._onClose("transport close",e))}onOpen(){this.readyState="open",A.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush()}_onPacket(t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",t),this.emitReserved("heartbeat"),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const e=new Error("server error");e.code=t.data,this._onError(e);break;case"message":this.emitReserved("data",t.data),this.emitReserved("message",t.data);break}}onHandshake(t){this.emitReserved("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this._pingInterval=t.pingInterval,this._pingTimeout=t.pingTimeout,this._maxPayload=t.maxPayload,this.onOpen(),this.readyState!=="closed"&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const t=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+t,this._pingTimeoutTimer=this.setTimeoutFn(()=>{this._onClose("ping timeout")},t),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const t=this._getWritablePackets();this.transport.send(t),this._prevBufferLen=t.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let e=1;for(let s=0;s<this.writeBuffer.length;s++){const n=this.writeBuffer[s].data;if(n&&(e+=zt(n)),s>0&&e>this._maxPayload)return this.writeBuffer.slice(0,s);e+=2}return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const t=Date.now()>this._pingTimeoutTime;return t&&(this._pingTimeoutTime=0,K(()=>{this._onClose("ping timeout")},this.setTimeoutFn)),t}write(t,e,s){return this._sendPacket("message",t,e,s),this}send(t,e,s){return this._sendPacket("message",t,e,s),this}_sendPacket(t,e,s,n){if(typeof e=="function"&&(n=e,e=void 0),typeof s=="function"&&(n=s,s=null),this.readyState==="closing"||this.readyState==="closed")return;s=s||{},s.compress=s.compress!==!1;const r={type:t,data:e,options:s};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),n&&this.once("flush",n),this.flush()}close(){const t=()=>{this._onClose("forced close"),this.transport.close()},e=()=>{this.off("upgrade",e),this.off("upgradeError",e),t()},s=()=>{this.once("upgrade",e),this.once("upgradeError",e)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?s():t()}):this.upgrading?s():t()),this}_onError(t){if(A.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&this.readyState==="opening")return this.transports.shift(),this._open();this.emitReserved("error",t),this._onClose("transport error",t)}_onClose(t,e){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing"){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),tt&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const s=U.indexOf(this._offlineEventListener);s!==-1&&U.splice(s,1)}this.readyState="closed",this.id=null,this.emitReserved("close",t,e),this.writeBuffer=[],this._prevBufferLen=0}}}A.protocol=Ct;class pe extends A{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),this.readyState==="open"&&this.opts.upgrade)for(let t=0;t<this._upgrades.length;t++)this._probe(this._upgrades[t])}_probe(t){let e=this.createTransport(t),s=!1;A.priorWebsocketSuccess=!1;const n=()=>{s||(e.send([{type:"ping",data:"probe"}]),e.once("packet",f=>{if(!s)if(f.type==="pong"&&f.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;A.priorWebsocketSuccess=e.name==="websocket",this.transport.pause(()=>{s||this.readyState!=="closed"&&(l(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())})}else{const u=new Error("probe error");u.transport=e.name,this.emitReserved("upgradeError",u)}}))};function r(){s||(s=!0,l(),e.close(),e=null)}const o=f=>{const u=new Error("probe error: "+f);u.transport=e.name,r(),this.emitReserved("upgradeError",u)};function c(){o("transport closed")}function a(){o("socket closed")}function h(f){e&&f.name!==e.name&&r()}const l=()=>{e.removeListener("open",n),e.removeListener("error",o),e.removeListener("close",c),this.off("close",a),this.off("upgrading",h)};e.once("open",n),e.once("error",o),e.once("close",c),this.once("close",a),this.once("upgrading",h),this._upgrades.indexOf("webtransport")!==-1&&t!=="webtransport"?this.setTimeoutFn(()=>{s||e.open()},200):e.open()}onHandshake(t){this._upgrades=this._filterUpgrades(t.upgrades),super.onHandshake(t)}_filterUpgrades(t){const e=[];for(let s=0;s<t.length;s++)~this.transports.indexOf(t[s])&&e.push(t[s]);return e}}let ge=class extends pe{constructor(t,e={}){const s=typeof t=="object"?t:e;(!s.transports||s.transports&&typeof s.transports[0]=="string")&&(s.transports=(s.transports||["polling","websocket","webtransport"]).map(n=>he[n]).filter(n=>!!n)),super(t,s)}};function me(i,t="",e){let s=i;e=e||typeof location<"u"&&location,i==null&&(i=e.protocol+"//"+e.host),typeof i=="string"&&(i.charAt(0)==="/"&&(i.charAt(1)==="/"?i=e.protocol+i:i=e.host+i),/^(https?|wss?):\/\//.test(i)||(typeof e<"u"?i=e.protocol+"//"+i:i="https://"+i),s=Z(i)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";const r=s.host.indexOf(":")!==-1?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+r+":"+s.port+t,s.href=s.protocol+"://"+r+(e&&e.port===s.port?"":":"+s.port),s}const ye=typeof ArrayBuffer=="function",be=i=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(i):i.buffer instanceof ArrayBuffer,Ot=Object.prototype.toString,we=typeof Blob=="function"||typeof Blob<"u"&&Ot.call(Blob)==="[object BlobConstructor]",xe=typeof File=="function"||typeof File<"u"&&Ot.call(File)==="[object FileConstructor]";function at(i){return ye&&(i instanceof ArrayBuffer||be(i))||we&&i instanceof Blob||xe&&i instanceof File}function F(i,t){if(!i||typeof i!="object")return!1;if(Array.isArray(i)){for(let e=0,s=i.length;e<s;e++)if(F(i[e]))return!0;return!1}if(at(i))return!0;if(i.toJSON&&typeof i.toJSON=="function"&&arguments.length===1)return F(i.toJSON(),!0);for(const e in i)if(Object.prototype.hasOwnProperty.call(i,e)&&F(i[e]))return!0;return!1}function ke(i){const t=[],e=i.data,s=i;return s.data=et(e,t),s.attachments=t.length,{packet:s,buffers:t}}function et(i,t){if(!i)return i;if(at(i)){const e={_placeholder:!0,num:t.length};return t.push(i),e}else if(Array.isArray(i)){const e=new Array(i.length);for(let s=0;s<i.length;s++)e[s]=et(i[s],t);return e}else if(typeof i=="object"&&!(i instanceof Date)){const e={};for(const s in i)Object.prototype.hasOwnProperty.call(i,s)&&(e[s]=et(i[s],t));return e}return i}function ve(i,t){return i.data=st(i.data,t),delete i.attachments,i}function st(i,t){if(!i)return i;if(i&&i._placeholder===!0){if(typeof i.num=="number"&&i.num>=0&&i.num<t.length)return t[i.num];throw new Error("illegal attachments")}else if(Array.isArray(i))for(let e=0;e<i.length;e++)i[e]=st(i[e],t);else if(typeof i=="object")for(const e in i)Object.prototype.hasOwnProperty.call(i,e)&&(i[e]=st(i[e],t));return i}const _e=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var d;(function(i){i[i.CONNECT=0]="CONNECT",i[i.DISCONNECT=1]="DISCONNECT",i[i.EVENT=2]="EVENT",i[i.ACK=3]="ACK",i[i.CONNECT_ERROR=4]="CONNECT_ERROR",i[i.BINARY_EVENT=5]="BINARY_EVENT",i[i.BINARY_ACK=6]="BINARY_ACK"})(d||(d={}));class Ce{constructor(t){this.replacer=t}encode(t){return(t.type===d.EVENT||t.type===d.ACK)&&F(t)?this.encodeAsBinary({type:t.type===d.EVENT?d.BINARY_EVENT:d.BINARY_ACK,nsp:t.nsp,data:t.data,id:t.id}):[this.encodeAsString(t)]}encodeAsString(t){let e=""+t.type;return(t.type===d.BINARY_EVENT||t.type===d.BINARY_ACK)&&(e+=t.attachments+"-"),t.nsp&&t.nsp!=="/"&&(e+=t.nsp+","),t.id!=null&&(e+=t.id),t.data!=null&&(e+=JSON.stringify(t.data,this.replacer)),e}encodeAsBinary(t){const e=ke(t),s=this.encodeAsString(e.packet),n=e.buffers;return n.unshift(s),n}}class ct extends m{constructor(t){super(),this.reviver=t}add(t){let e;if(typeof t=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");e=this.decodeString(t);const s=e.type===d.BINARY_EVENT;s||e.type===d.BINARY_ACK?(e.type=s?d.EVENT:d.ACK,this.reconstructor=new Re(e),e.attachments===0&&super.emitReserved("decoded",e)):super.emitReserved("decoded",e)}else if(at(t)||t.base64)if(this.reconstructor)e=this.reconstructor.takeBinaryData(t),e&&(this.reconstructor=null,super.emitReserved("decoded",e));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+t)}decodeString(t){let e=0;const s={type:Number(t.charAt(0))};if(d[s.type]===void 0)throw new Error("unknown packet type "+s.type);if(s.type===d.BINARY_EVENT||s.type===d.BINARY_ACK){const r=e+1;for(;t.charAt(++e)!=="-"&&e!=t.length;);const o=t.substring(r,e);if(o!=Number(o)||t.charAt(e)!=="-")throw new Error("Illegal attachments");s.attachments=Number(o)}if(t.charAt(e+1)==="/"){const r=e+1;for(;++e&&!(t.charAt(e)===","||e===t.length););s.nsp=t.substring(r,e)}else s.nsp="/";const n=t.charAt(e+1);if(n!==""&&Number(n)==n){const r=e+1;for(;++e;){const o=t.charAt(e);if(o==null||Number(o)!=o){--e;break}if(e===t.length)break}s.id=Number(t.substring(r,e+1))}if(t.charAt(++e)){const r=this.tryParse(t.substr(e));if(ct.isPayloadValid(s.type,r))s.data=r;else throw new Error("invalid payload")}return s}tryParse(t){try{return JSON.parse(t,this.reviver)}catch{return!1}}static isPayloadValid(t,e){switch(t){case d.CONNECT:return mt(e);case d.DISCONNECT:return e===void 0;case d.CONNECT_ERROR:return typeof e=="string"||mt(e);case d.EVENT:case d.BINARY_EVENT:return Array.isArray(e)&&(typeof e[0]=="number"||typeof e[0]=="string"&&_e.indexOf(e[0])===-1);case d.ACK:case d.BINARY_ACK:return Array.isArray(e)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Re{constructor(t){this.packet=t,this.buffers=[],this.reconPack=t}takeBinaryData(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){const e=ve(this.reconPack,this.buffers);return this.finishedReconstruction(),e}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function mt(i){return Object.prototype.toString.call(i)==="[object Object]"}const Be=Object.freeze(Object.defineProperty({__proto__:null,Decoder:ct,Encoder:Ce,get PacketType(){return d}},Symbol.toStringTag,{value:"Module"}));function v(i,t,e){return i.on(t,e),function(){i.off(t,e)}}const Te=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class St extends m{constructor(t,e,s){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=t,this.nsp=e,s&&s.auth&&(this.auth=s.auth),this._opts=Object.assign({},s),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const t=this.io;this.subs=[v(t,"open",this.onopen.bind(this)),v(t,"packet",this.onpacket.bind(this)),v(t,"error",this.onerror.bind(this)),v(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...t){return t.unshift("message"),this.emit.apply(this,t),this}emit(t,...e){var s,n,r;if(Te.hasOwnProperty(t))throw new Error('"'+t.toString()+'" is a reserved event name');if(e.unshift(t),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(e),this;const o={type:d.EVENT,data:e};if(o.options={},o.options.compress=this.flags.compress!==!1,typeof e[e.length-1]=="function"){const l=this.ids++,f=e.pop();this._registerAckCallback(l,f),o.id=l}const c=(n=(s=this.io.engine)===null||s===void 0?void 0:s.transport)===null||n===void 0?void 0:n.writable,a=this.connected&&!(!((r=this.io.engine)===null||r===void 0)&&r._hasPingExpired());return this.flags.volatile&&!c||(a?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}_registerAckCallback(t,e){var s;const n=(s=this.flags.timeout)!==null&&s!==void 0?s:this._opts.ackTimeout;if(n===void 0){this.acks[t]=e;return}const r=this.io.setTimeoutFn(()=>{delete this.acks[t];for(let c=0;c<this.sendBuffer.length;c++)this.sendBuffer[c].id===t&&this.sendBuffer.splice(c,1);e.call(this,new Error("operation has timed out"))},n),o=(...c)=>{this.io.clearTimeoutFn(r),e.apply(this,c)};o.withError=!0,this.acks[t]=o}emitWithAck(t,...e){return new Promise((s,n)=>{const r=(o,c)=>o?n(o):s(c);r.withError=!0,e.push(r),this.emit(t,...e)})}_addToQueue(t){let e;typeof t[t.length-1]=="function"&&(e=t.pop());const s={id:this._queueSeq++,tryCount:0,pending:!1,args:t,flags:Object.assign({fromQueue:!0},this.flags)};t.push((n,...r)=>(this._queue[0],n!==null?s.tryCount>this._opts.retries&&(this._queue.shift(),e&&e(n)):(this._queue.shift(),e&&e(null,...r)),s.pending=!1,this._drainQueue())),this._queue.push(s),this._drainQueue()}_drainQueue(t=!1){if(!this.connected||this._queue.length===0)return;const e=this._queue[0];e.pending&&!t||(e.pending=!0,e.tryCount++,this.flags=e.flags,this.emit.apply(this,e.args))}packet(t){t.nsp=this.nsp,this.io._packet(t)}onopen(){typeof this.auth=="function"?this.auth(t=>{this._sendConnectPacket(t)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(t){this.packet({type:d.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},t):t})}onerror(t){this.connected||this.emitReserved("connect_error",t)}onclose(t,e){this.connected=!1,delete this.id,this.emitReserved("disconnect",t,e),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(t=>{if(!this.sendBuffer.some(s=>String(s.id)===t)){const s=this.acks[t];delete this.acks[t],s.withError&&s.call(this,new Error("socket has been disconnected"))}})}onpacket(t){if(t.nsp===this.nsp)switch(t.type){case d.CONNECT:t.data&&t.data.sid?this.onconnect(t.data.sid,t.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case d.EVENT:case d.BINARY_EVENT:this.onevent(t);break;case d.ACK:case d.BINARY_ACK:this.onack(t);break;case d.DISCONNECT:this.ondisconnect();break;case d.CONNECT_ERROR:this.destroy();const s=new Error(t.data.message);s.data=t.data.data,this.emitReserved("connect_error",s);break}}onevent(t){const e=t.data||[];t.id!=null&&e.push(this.ack(t.id)),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(t){if(this._anyListeners&&this._anyListeners.length){const e=this._anyListeners.slice();for(const s of e)s.apply(this,t)}super.emit.apply(this,t),this._pid&&t.length&&typeof t[t.length-1]=="string"&&(this._lastOffset=t[t.length-1])}ack(t){const e=this;let s=!1;return function(...n){s||(s=!0,e.packet({type:d.ACK,id:t,data:n}))}}onack(t){const e=this.acks[t.id];typeof e=="function"&&(delete this.acks[t.id],e.withError&&t.data.unshift(null),e.apply(this,t.data))}onconnect(t,e){this.id=t,this.recovered=e&&this._pid===e,this._pid=e,this.connected=!0,this.emitBuffered(),this._drainQueue(!0),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(t=>this.emitEvent(t)),this.receiveBuffer=[],this.sendBuffer.forEach(t=>{this.notifyOutgoingListeners(t),this.packet(t)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(t=>t()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:d.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(t){return this.flags.compress=t,this}get volatile(){return this.flags.volatile=!0,this}timeout(t){return this.flags.timeout=t,this}onAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(t),this}prependAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(t),this}offAny(t){if(!this._anyListeners)return this;if(t){const e=this._anyListeners;for(let s=0;s<e.length;s++)if(t===e[s])return e.splice(s,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(t),this}prependAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(t),this}offAnyOutgoing(t){if(!this._anyOutgoingListeners)return this;if(t){const e=this._anyOutgoingListeners;for(let s=0;s<e.length;s++)if(t===e[s])return e.splice(s,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(t){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const e=this._anyOutgoingListeners.slice();for(const s of e)s.apply(this,t.data)}}}function S(i){i=i||{},this.ms=i.min||100,this.max=i.max||1e4,this.factor=i.factor||2,this.jitter=i.jitter>0&&i.jitter<=1?i.jitter:0,this.attempts=0}S.prototype.duration=function(){var i=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var t=Math.random(),e=Math.floor(t*this.jitter*i);i=(Math.floor(t*10)&1)==0?i-e:i+e}return Math.min(i,this.max)|0};S.prototype.reset=function(){this.attempts=0};S.prototype.setMin=function(i){this.ms=i};S.prototype.setMax=function(i){this.max=i};S.prototype.setJitter=function(i){this.jitter=i};class it extends m{constructor(t,e){var s;super(),this.nsps={},this.subs=[],t&&typeof t=="object"&&(e=t,t=void 0),e=e||{},e.path=e.path||"/socket.io",this.opts=e,G(this,e),this.reconnection(e.reconnection!==!1),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor((s=e.randomizationFactor)!==null&&s!==void 0?s:.5),this.backoff=new S({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(e.timeout==null?2e4:e.timeout),this._readyState="closed",this.uri=t;const n=e.parser||Be;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this._autoConnect=e.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(t){return arguments.length?(this._reconnection=!!t,t||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(t){return t===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=t,this)}reconnectionDelay(t){var e;return t===void 0?this._reconnectionDelay:(this._reconnectionDelay=t,(e=this.backoff)===null||e===void 0||e.setMin(t),this)}randomizationFactor(t){var e;return t===void 0?this._randomizationFactor:(this._randomizationFactor=t,(e=this.backoff)===null||e===void 0||e.setJitter(t),this)}reconnectionDelayMax(t){var e;return t===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=t,(e=this.backoff)===null||e===void 0||e.setMax(t),this)}timeout(t){return arguments.length?(this._timeout=t,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(t){if(~this._readyState.indexOf("open"))return this;this.engine=new ge(this.uri,this.opts);const e=this.engine,s=this;this._readyState="opening",this.skipReconnect=!1;const n=v(e,"open",function(){s.onopen(),t&&t()}),r=c=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",c),t?t(c):this.maybeReconnectOnOpen()},o=v(e,"error",r);if(this._timeout!==!1){const c=this._timeout,a=this.setTimeoutFn(()=>{n(),r(new Error("timeout")),e.close()},c);this.opts.autoUnref&&a.unref(),this.subs.push(()=>{this.clearTimeoutFn(a)})}return this.subs.push(n),this.subs.push(o),this}connect(t){return this.open(t)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const t=this.engine;this.subs.push(v(t,"ping",this.onping.bind(this)),v(t,"data",this.ondata.bind(this)),v(t,"error",this.onerror.bind(this)),v(t,"close",this.onclose.bind(this)),v(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(e){this.onclose("parse error",e)}}ondecoded(t){K(()=>{this.emitReserved("packet",t)},this.setTimeoutFn)}onerror(t){this.emitReserved("error",t)}socket(t,e){let s=this.nsps[t];return s?this._autoConnect&&!s.active&&s.connect():(s=new St(this,t,e),this.nsps[t]=s),s}_destroy(t){const e=Object.keys(this.nsps);for(const s of e)if(this.nsps[s].active)return;this._close()}_packet(t){const e=this.encoder.encode(t);for(let s=0;s<e.length;s++)this.engine.write(e[s],t.options)}cleanup(){this.subs.forEach(t=>t()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(t,e){var s;this.cleanup(),(s=this.engine)===null||s===void 0||s.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",t,e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const e=this.backoff.duration();this._reconnecting=!0;const s=this.setTimeoutFn(()=>{t.skipReconnect||(this.emitReserved("reconnect_attempt",t.backoff.attempts),!t.skipReconnect&&t.open(n=>{n?(t._reconnecting=!1,t.reconnect(),this.emitReserved("reconnect_error",n)):t.onreconnect()}))},e);this.opts.autoUnref&&s.unref(),this.subs.push(()=>{this.clearTimeoutFn(s)})}}onreconnect(){const t=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",t)}}const N={};function V(i,t){typeof i=="object"&&(t=i,i=void 0),t=t||{};const e=me(i,t.path||"/socket.io"),s=e.source,n=e.id,r=e.path,o=N[n]&&r in N[n].nsps,c=t.forceNew||t["force new connection"]||t.multiplex===!1||o;let a;return c?a=new it(s,t):(N[n]||(N[n]=new it(s,t)),a=N[n]),e.query&&!t.query&&(t.query=e.queryKey),a.socket(e.path,t)}Object.assign(V,{Manager:it,Socket:St,io:V,connect:V});class Ae{socket;callbacks={};constructor(){this.socket=V(void 0),this.setupListeners()}getSocket(){return this.socket}setCallbacks(t){this.callbacks={...this.callbacks,...t}}setupListeners(){this.socket.on("init",t=>{this.callbacks.onInit?.(t)}),this.socket.on("newPlayer",t=>{this.callbacks.onNewPlayer?.(t)}),this.socket.on("playerMoved",t=>{this.callbacks.onPlayerMoved?.(t)}),this.socket.on("playerStatUpdate",t=>{this.callbacks.onPlayerStatUpdate?.(t)}),this.socket.on("worldUpdate",t=>{this.callbacks.onWorldUpdate?.(t)}),this.socket.on("playerDied",t=>{this.callbacks.onPlayerDied?.(t)}),this.socket.on("playerDisconnected",t=>{this.callbacks.onPlayerDisconnected?.(t)}),this.socket.on("seasonChange",t=>{this.callbacks.onSeasonChange?.(t)}),this.socket.on("projectileUpdate",t=>{this.callbacks.onProjectileUpdate?.(t)}),this.socket.on("chatMsg",t=>{this.callbacks.onChatMsg?.(t)}),this.socket.on("deathScreen",t=>{this.callbacks.onDeathScreen?.(t)}),this.socket.on("textMessage",t=>{this.callbacks.onTextMessage?.(t)}),this.socket.on("nameBaby",t=>{this.callbacks.onNameBaby?.(t)}),this.socket.on("nameError",t=>{this.callbacks.onNameError?.(t)}),this.socket.on("nameSuccess",t=>{this.callbacks.onNameSuccess?.(t)})}emit(t,e){this.socket.emit(t,e)}}class Ee{audioCtx;constructor(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext)}play(t){const e=this.audioCtx.createOscillator(),s=this.audioCtx.createGain();e.connect(s),s.connect(this.audioCtx.destination);const n=this.audioCtx.currentTime;switch(t){case"pick":case"shoot":e.type="sine",e.frequency.setValueAtTime(440,n),e.frequency.exponentialRampToValueAtTime(880,n+.1),s.gain.setValueAtTime(.1,n),s.gain.exponentialRampToValueAtTime(.01,n+.1),e.start(n),e.stop(n+.1);break;case"drop":e.type="sine",e.frequency.setValueAtTime(440,n),e.frequency.exponentialRampToValueAtTime(220,n+.1),s.gain.setValueAtTime(.1,n),s.gain.exponentialRampToValueAtTime(.01,n+.1),e.start(n),e.stop(n+.1);break;case"eat":e.type="triangle",e.frequency.setValueAtTime(200,n),e.frequency.exponentialRampToValueAtTime(100,n+.2),s.gain.setValueAtTime(.2,n),s.gain.exponentialRampToValueAtTime(.01,n+.2),e.start(n),e.stop(n+.2);break;case"craft":e.type="square",e.frequency.setValueAtTime(150,n),e.frequency.exponentialRampToValueAtTime(300,n+.05),s.gain.setValueAtTime(.05,n),s.gain.exponentialRampToValueAtTime(.01,n+.1),e.start(n),e.stop(n+.1);break}}resume(){this.audioCtx.state==="suspended"&&this.audioCtx.resume()}}class Oe{keys={};isChatting=!1;canvas;socket;audio;callbacks={};registry=null;recipes=[];getPlayerHolding=()=>null;getPlayerData=()=>null;getWorldData=()=>null;getPlayersData=()=>null;getMyId=()=>null;targetPosition=null;bounceState=null;constructor(t,e,s){this.canvas=t,this.socket=e,this.audio=s,this.setupListeners()}setCallbacks(t){this.callbacks=t}setPlayerHoldingGetter(t){this.getPlayerHolding=t}setPlayerDataGetter(t){this.getPlayerData=t}setWorldDataGetter(t){this.getWorldData=t}setPlayersDataGetter(t){this.getPlayersData=t}setMyIdGetter(t){this.getMyId=t}setRegistry(t){this.registry=t}setRecipes(t){this.recipes=t}getItemIdByKey(t){return this.registry?this.registry.items[t]?.id??null:null}setChatting(t){this.isChatting=t}isChatMode(){return this.isChatting}setupListeners(){window.addEventListener("keydown",t=>{this.keys[t.key.toLowerCase()]=!0,(t.key==="t"||t.key==="T"||t.key==="Enter")&&!this.isChatting&&(t.preventDefault(),this.callbacks.onChatFocus?.()),(t.key==="b"||t.key==="B")&&!this.isChatting&&(t.preventDefault(),this.socket.emit("dropBackpack")),(t.key==="g"||t.key==="G")&&!this.isChatting&&(t.preventDefault(),this.socket.emit("addToBackpack")),(t.key==="h"||t.key==="H")&&!this.isChatting&&(t.preventDefault(),this.socket.emit("takeFromBackpack"))}),window.addEventListener("keyup",t=>{this.keys[t.key.toLowerCase()]=!1}),window.addEventListener("mousedown",t=>{this.isChatting||t.button===0&&this.handleContextualClick(t)}),this.canvas.addEventListener("mousemove",t=>{if(!this.callbacks.onShowObjectActions)return;const e=this.getPlayerData();if(!e)return;const s=this.canvas.getBoundingClientRect(),n=t.clientX-s.left,r=t.clientY-s.top,o=n-this.canvas.width/2+e.x,c=r-this.canvas.height/2+e.y,a=this.getObjectAtPosition(o,c),h=this.getPlayerHolding();a?this.callbacks.onShowObjectActions(a,h):this.callbacks.onShowObjectActions(null,null)})}handleContextualClick(t){const e=this.canvas.getBoundingClientRect(),s=t.clientX-e.left,n=t.clientY-e.top,r=this.getPlayerData();if(!r)return;const o=this.canvas.width/2,c=this.canvas.height/2,a=r.x+(s-o),h=r.y+(n-c),l=this.keys.shift,f=this.getObjectAtPosition(a,h),u=this.getPlayerHolding(),b=Math.floor(r.x/64),g=Math.floor(r.y/64),x=this.getObjectAtPosition(r.x,r.y),O=Math.floor(a/64),T=Math.floor(h/64),P=Math.abs(O-b),lt=Math.abs(T-g),ut=P===0&&lt===0,Y=P<=1&&lt<=1;if(l&&u){const E=this.getItemIdByKey("BOW"),L=this.getItemIdByKey("SPEAR");if(u===E||u===L){const Dt=Math.atan2(n-c,s-o);this.socket.emit("shoot",{angle:Dt}),this.audio.play("shoot");return}}if(f)if(ut&&f===x)if(u){const E=this.getObjectMetadataById(u);E&&E.isEdible?(this.socket.emit("eat"),this.audio.play("eat")):(this.socket.emit("use"),this.audio.play("craft"))}else this.hasBareHandsRecipe(f)?(this.socket.emit("use"),this.audio.play("craft")):(this.socket.emit("pickUp"),this.audio.play("pick"));else Y&&u?(this.bounceState={originalPosition:{x:r.x,y:r.y},targetObject:{x:O*64+32,y:T*64+32},phase:"moving-to",useTimer:0},this.targetPosition=null):Y?this.targetPosition={x:O*64+32,y:T*64+32}:this.targetPosition={x:O*64+32,y:T*64+32};else u&&ut?this.recipes.some(L=>L.tool===u&&L.target===null)&&(l||t.shiftKey)?(this.socket.emit("use"),this.audio.play("craft")):(this.socket.emit("drop"),this.audio.play("drop")):this.getBabyAtPosition(a,h)&&!u&&Y?(this.socket.emit("pickUp"),this.audio.play("pick")):this.targetPosition={x:a,y:h}}getBabyAtPosition(t,e){const s=this.getPlayersData(),n=this.getMyId();if(!s||!n)return null;const r=Math.floor(t/64),o=Math.floor(e/64);for(const c in s){if(c===n)continue;const a=s[c],h=Math.floor(a.x/64),l=Math.floor(a.y/64);if(h===r&&l===o&&a.age<3&&!a.heldBy)return a}return null}getObjectAtPosition(t,e){const s=this.getWorldData();if(!s)return null;const n=Math.floor(t/64),r=Math.floor(e/64),o=`${n},${r}`;return s.objects[o]??null}getObjectMetadataById(t){if(!this.registry)return null;const e=Object.values(this.registry.resources).find(r=>r.id===t);if(e)return e;const s=Object.values(this.registry.items).find(r=>r.id===t);if(s)return s;const n=Object.values(this.registry.animals).find(r=>r.id===t);return n||null}getObjectCategory(t){return this.registry?Object.values(this.registry.items).find(e=>e.id===t)?"item":Object.values(this.registry.resources).find(e=>e.id===t)?"resource":Object.values(this.registry.animals).find(e=>e.id===t)?"animal":null:null}hasBareHandsRecipe(t){return!this.recipes||this.recipes.length===0?!1:this.recipes.some(e=>e.tool===null&&e.target===t)}update(){if(this.isChatting)return;const t=this.getPlayerData();let e=0,s=0;if(this.bounceState&&t){if(this.bounceState.phase==="moving-to"){const n=this.bounceState.targetObject.x-t.x,r=this.bounceState.targetObject.y-t.y;if(Math.sqrt(n*n+r*r)<8)this.bounceState.phase="using",this.bounceState.useTimer=0,this.socket.emit("use"),this.audio.play("craft");else{const c=Math.atan2(r,n);e=Math.cos(c)*3,s=Math.sin(c)*3}}else if(this.bounceState.phase==="using")this.bounceState.useTimer++,this.bounceState.useTimer>5&&(this.bounceState.phase="moving-back");else if(this.bounceState.phase==="moving-back"){const n=this.bounceState.originalPosition.x-t.x,r=this.bounceState.originalPosition.y-t.y;if(Math.sqrt(n*n+r*r)<5)this.bounceState=null;else{const c=Math.atan2(r,n);e=Math.cos(c)*3,s=Math.sin(c)*3}}}else if(this.targetPosition&&t){const n=this.targetPosition.x-t.x,r=this.targetPosition.y-t.y;if(Math.sqrt(n*n+r*r)<5)this.targetPosition=null;else{const c=Math.atan2(r,n);e=Math.cos(c)*2,s=Math.sin(c)*2}}(this.keys.arrowup||this.keys.w)&&(s=-2,this.targetPosition=null,this.bounceState=null),(this.keys.arrowdown||this.keys.s)&&(s=2,this.targetPosition=null,this.bounceState=null),(this.keys.arrowleft||this.keys.a)&&(e=-2,this.targetPosition=null,this.bounceState=null),(this.keys.arrowright||this.keys.d)&&(e=2,this.targetPosition=null,this.bounceState=null),(e!==0||s!==0)&&this.socket.emit("move",{dx:e,dy:s}),this.keys.r&&(this.callbacks.onToggleRecipeBook?.(),this.keys.r=!1),this.keys.e&&(this.socket.emit("eat"),this.audio.play("eat"),this.keys.e=!1)}}class Se{particles=[];canvas;ctx;weatherEnabled=!0;constructor(t,e){this.canvas=t,this.ctx=e,this.initParticles(),window.addEventListener("resize",()=>this.initParticles())}setWeatherEnabled(t){this.weatherEnabled=t}initParticles(){this.particles=[];for(let t=0;t<100;t++)this.particles.push({x:Math.random()*this.canvas.width,y:Math.random()*this.canvas.height,speed:2+Math.random()*3,size:1+Math.random()*2})}applySeasonEffects(t){if(this.ctx.save(),this.ctx.globalCompositeOperation="multiply",t==="summer")this.ctx.fillStyle="rgba(255, 255, 0, 0.05)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);else if(t==="autumn")this.ctx.fillStyle="rgba(255, 100, 0, 0.1)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);else if(t==="winter"){this.ctx.fillStyle="rgba(200, 200, 255, 0.15)",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="white";for(let e=0;e<50;e++){const s=Math.random()*this.canvas.width,n=Math.random()*this.canvas.height;this.ctx.beginPath(),this.ctx.arc(s,n,1,0,Math.PI*2),this.ctx.fill()}}this.ctx.restore()}drawWeather(t){this.weatherEnabled&&(t!=="winter"&&t!=="autumn"||(this.ctx.save(),t==="winter"?this.ctx.fillStyle="rgba(255, 255, 255, 0.8)":t==="autumn"&&(this.ctx.fillStyle="rgba(100, 150, 255, 0.4)"),this.particles.forEach(e=>{t==="winter"?(e.y+=e.speed*.5,e.x+=Math.sin(Date.now()/1e3+e.x)*.5,this.ctx.beginPath(),this.ctx.arc(e.x,e.y,e.size,0,Math.PI*2),this.ctx.fill()):t==="autumn"&&(e.y+=e.speed*2,e.x+=1,this.ctx.lineWidth=1,this.ctx.strokeStyle="rgba(100, 150, 255, 0.6)",this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(e.x+2,e.y+10),this.ctx.stroke()),e.y>this.canvas.height&&(e.y=-10),e.x>this.canvas.width&&(e.x=-10)}),this.ctx.restore()))}}class Pe{chatInput;chatDisplay;socket;getObjectName;onChatFocusChange;currentBabyId=null;actionPopup;actionContent;hideTimer=null;availableRecipes=[];constructor(t,e){this.socket=t,this.getObjectName=e,this.chatInput=document.getElementById("chat-input"),this.chatDisplay=document.getElementById("chat-display"),this.setupChatListeners(),this.setupNamingModal(),this.setupActionPopup()}setOnChatFocusChange(t){this.onChatFocusChange=t}setRecipes(t){this.availableRecipes=t}focusChat(){this.chatInput.focus()}setupChatListeners(){this.chatInput.addEventListener("focus",()=>{this.onChatFocusChange?.(!0)}),this.chatInput.addEventListener("blur",()=>{this.onChatFocusChange?.(!1)}),this.chatInput.addEventListener("keydown",t=>{if(t.key==="Enter"){const e=this.chatInput.value.trim();e&&(this.socket.emit("chat",e),this.chatInput.value=""),this.chatInput.blur()}t.stopPropagation()})}setupNamingModal(){const t=document.getElementById("confirm-name-btn"),e=document.getElementById("baby-name-input");t&&e&&(t.addEventListener("click",()=>this.submitBabyName()),e.addEventListener("keydown",s=>{s.key==="Enter"&&this.submitBabyName(),s.stopPropagation()}))}submitBabyName(){const t=document.getElementById("baby-name-input"),e=document.getElementById("name-error");if(!t||!this.currentBabyId)return;const s=t.value.trim();if(!s){e&&(e.textContent="Please enter a name");return}if(s.length>20){e&&(e.textContent="Name must be 20 characters or less");return}if(/\s/.test(s)){e&&(e.textContent="Name must be a single word");return}if(!/^[a-zA-Z-]+$/.test(s)){e&&(e.textContent="Name must contain only letters");return}e&&(e.textContent=""),this.socket.emit("nameBaby",{babyId:this.currentBabyId,name:s})}showNamingModal(t){const e=document.getElementById("name-baby-modal"),s=document.getElementById("name-baby-message"),n=document.getElementById("baby-name-input"),r=document.getElementById("name-error");e&&s&&n&&(this.currentBabyId=t.babyId,s.textContent=t.message,n.value="",r&&(r.textContent=""),e.style.display="flex",n.focus(),this.onChatFocusChange?.(!0))}hideNamingModal(){const t=document.getElementById("name-baby-modal");t&&(t.style.display="none",this.currentBabyId=null,this.onChatFocusChange?.(!1))}showNameError(t){const e=document.getElementById("name-error");e&&(e.textContent=t)}addChatMessage(t,e){const s=document.createElement("div");s.className="chat-msg",s.innerHTML=`<span class="name">${t}:</span> ${e}`,this.chatDisplay.prepend(s),this.chatDisplay.children.length>50&&this.chatDisplay.lastChild&&this.chatDisplay.removeChild(this.chatDisplay.lastChild)}showDeathScreen(t){const e=document.getElementById("death-screen"),s=document.getElementById("death-summary");e&&(e.style.display="flex"),s&&(s.innerHTML=`
                <strong>${t.name}</strong><br><br>
                You lived to be <strong>${t.age}</strong> years old.<br>
                Experience gained: <strong>${t.experience||0}</strong> XP.<br>
                Cause of death: <strong>${t.cause}</strong>.<br>
                Your mother was <strong>${t.mother}</strong>.<br><br>
                <em>Life is short, but the world remembers your passing.</em>
            `);const n=document.getElementById("stats-container");n&&(n.style.display="none")}showNotification(t,e=5e3){const s=document.getElementById("ui");if(!s)return;const n=document.createElement("div");n.className="notification",n.innerText=t,s.appendChild(n),setTimeout(()=>n.remove(),e)}updateSeason(t){const e=document.getElementById("seasonVal");if(!e)return;e.innerText=t.charAt(0).toUpperCase()+t.slice(1);const s={spring:"#4caf50",summer:"#ffeb3b",autumn:"#ff9800",winter:"#2196f3"};e.style.color=s[t]}updatePlayerStats(t){const e=document.getElementById("ageVal"),s=document.getElementById("expVal"),n=document.getElementById("hungerBar"),r=document.getElementById("coords"),o=document.getElementById("holdingVal");e&&(e.innerText=String(t.age)),s&&(s.innerText=String(t.experience||0));const c=t.hunger/t.maxHunger*100;n&&(n.style.width=`${c}%`),r&&(r.innerText=`Pos: ${Math.round(t.x)}, ${Math.round(t.y)}`);let a="None";t.holding&&(a=this.getObjectName(t.holding),t.holdingData?.inventory?a+=` (${t.holdingData.inventory.length}/3)`:t.holdingData?.usesRemaining!==void 0&&(a+=` (${t.holdingData.usesRemaining} uses)`)),o&&(o.innerText=a)}populateRecipes(t){const e=document.getElementById("recipe-list");e&&(e.innerHTML="",t.forEach(s=>{const n=document.createElement("div");n.style.marginBottom="8px",n.style.fontSize="12px";const r=s.tool===null?" Bare Hands":this.getObjectName(s.tool);n.innerHTML=`
                <strong style="color: #4caf50;">${this.getObjectName(s.result)}</strong><br/>
                <span style="color: #aaa;">${r} + ${this.getObjectName(s.target)}</span>
            `,e.appendChild(n)}))}toggleRecipeBook(t){const e=document.getElementById("recipe-book");e&&(e.style.display=e.style.display==="none"?"block":"none",e.style.display==="block"&&(this.availableRecipes=t,this.populateRecipes(t)))}setupActionPopup(){this.actionPopup=document.createElement("div"),this.actionPopup.className="action-popup",this.actionPopup.style.cssText=`
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            border: 2px solid #8b7355;
            font-family: Arial, sans-serif;
            font-size: 14px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            min-width: 200px;
            max-width: 300px;
            z-index: 1000;
        `,this.actionContent=document.createElement("div"),this.actionPopup.appendChild(this.actionContent),document.body.appendChild(this.actionPopup)}showObjectActions(t,e){if(this.hideTimer!==null&&(clearTimeout(this.hideTimer),this.hideTimer=null),t===null){this.hideActionPopup();return}const s=this.findMatchingRecipes(t,e),n=this.getObjectName(t);let r=`<div style="font-weight: bold; margin-bottom: 8px;">${n}</div>`;s.length>0?(r+='<div style="font-size: 12px; color: #aaa; margin-bottom: 6px;">Available recipes:</div>',s.forEach(o=>{const c=this.getObjectName(o.result),a=e?this.getObjectName(e):null;r+='<div style="margin: 4px 0; padding: 4px; background: rgba(139, 115, 85, 0.2); border-radius: 4px;">',r+='<span style="color: #8b7355;"></span> ',a&&(r+=`<span style="color: #ffd700;">${a}</span> + `),r+=`<span style="color: #90ee90;">${n}</span> `,r+='<span style="color: #8b7355;"></span> ',r+=`<span style="color: #87ceeb;">${c}</span>`,r+="</div>"})):this.availableRecipes.find(c=>c.target===t)?r+='<div style="color: #888; margin-top: 6px; font-style: italic;">Need tool to use</div>':e?r+='<div style="color: #888; margin-top: 6px; font-style: italic;">No recipes available</div>':r+='<div style="color: #87ceeb; margin-top: 6px;"> Pick up</div>',this.actionContent.innerHTML=r,requestAnimationFrame(()=>{this.actionPopup.style.opacity="1",this.actionPopup.style.transform="translateY(0)"})}hideActionPopup(){this.actionPopup.style.opacity="0",this.actionPopup.style.transform="translateY(20px)"}findMatchingRecipes(t,e){return this.availableRecipes?this.availableRecipes.filter(s=>s.target===t&&s.tool===e):[]}}const Ne={TILE_SIZE:64};class Me{ctx;images;getObjectImage;constructor(t,e,s){this.ctx=t,this.images=e,this.getObjectImage=s}draw(t,e,s,n,r){for(const o in t)this.drawSingle(t[o],e,s,n,o===r)}drawSingle(t,e,s,n,r=!1){const o=t.x+e,c=t.y+s,a=.45+Math.min(t.age,35)/35*.9,h=n*a;this.drawShadow(o,c,h),this.drawBackpack(t,o,c,h,a),this.drawSprite(t,o,c,h,r),this.drawNameTag(t,o,c,h,a),this.drawHeldItem(t,o,c,h,a),this.drawChatBubble(t,o,c)}drawShadow(t,e,s){this.ctx.fillStyle="rgba(0,0,0,0.15)",this.ctx.beginPath(),this.ctx.ellipse(t,e+s/3,s/2,s/4,0,0,Math.PI*2),this.ctx.fill()}drawSprite(t,e,s,n,r){let o;if(t.age<5)o=this.images.baby;else{const f=t.gender||"female";o=this.images[`player_${f}`]||this.images.player}const c=Date.now()*.005,a=Math.sin(c*2)*2,h=Math.sin(c)*.05,l=o instanceof HTMLCanvasElement||o instanceof HTMLImageElement&&o.complete&&o.naturalWidth>0;if(o&&l){if(this.ctx.save(),this.ctx.translate(e,s+n/2),this.ctx.rotate(h),this.ctx.translate(-e,-(s+n/2)),r&&(this.ctx.shadowBlur=10,this.ctx.shadowColor="#4caf50"),this.ctx.drawImage(o,e-n/2,s-n/2+a,n,n),t.age>=40&&t.gender==="male"){const f=Math.min((t.age-40)/30,1.2),u=Math.min(255,(t.age-40)*4);this.ctx.fillStyle=`rgba(${u},${u},${u}, 0.9)`,this.ctx.beginPath(),this.ctx.moveTo(e-n/6,s+n/20+a),this.ctx.lineTo(e+n/6,s+n/20+a),this.ctx.lineTo(e+n/10,s+n/4*f+a),this.ctx.lineTo(e-n/10,s+n/4*f+a),this.ctx.closePath(),this.ctx.fill()}this.ctx.restore()}else this.ctx.fillStyle=r?"#4caf50":"#ffffff",this.ctx.beginPath(),this.ctx.arc(e,s,n/2,0,Math.PI*2),this.ctx.fill()}drawNameTag(t,e,s,n,r){this.ctx.fillStyle="white",this.ctx.font=`bold ${Math.max(12,14*r)}px Arial`,this.ctx.textAlign="center",this.ctx.shadowColor="black",this.ctx.shadowBlur=4,this.ctx.fillText(t.name,e,s-n/1.2),this.ctx.shadowBlur=0,this.ctx.font=`${Math.max(8,10*r)}px Arial`,this.ctx.fillText(`Age: ${t.age}`,e,s-n/1)}drawHeldItem(t,e,s,n,r){if(!t.holding)return;const o=this.getObjectImage(t.holding),c=o instanceof HTMLCanvasElement||o instanceof HTMLImageElement&&o.complete&&o.naturalWidth>0;if(o&&c){const a=n*.5;this.ctx.drawImage(o,e+n/4,s-n/4,a,a),t.holdingData?.inventory?.length&&(this.ctx.fillStyle="white",this.ctx.font=`bold ${Math.max(8,10*r)}px Arial`,this.ctx.fillText(String(t.holdingData.inventory.length),e+n/2,s+n/4))}}drawBackpack(t,e,s,n,r){if(!t.backpack)return;const o=this.getObjectImage(t.backpack),c=o instanceof HTMLCanvasElement||o instanceof HTMLImageElement&&o.complete&&o.naturalWidth>0;if(o&&c){const a=n*.45,h=Math.sin(Date.now()*.01)*2;this.ctx.globalAlpha=.9,this.ctx.drawImage(o,e-n/3,s+h,a,a),this.ctx.globalAlpha=1,t.backpackData?.inventory?.length&&(this.ctx.fillStyle="white",this.ctx.font=`bold ${Math.max(8,10*r)}px Arial`,this.ctx.shadowColor="black",this.ctx.shadowBlur=2,this.ctx.fillText(String(t.backpackData.inventory.length),e-n/6,s+a+h),this.ctx.shadowBlur=0)}}drawChatBubble(t,e,s){t.lastMsg&&t.lastMsgTime&&Date.now()-t.lastMsgTime<5e3?this.drawBubble(e,s-60,t.lastMsg):t.hunger<=5&&this.drawBubble(e,s-60,"?",!0)}drawBubble(t,e,s,n=!1){this.ctx.font=n?"bold 16px Arial":"14px Arial";const o=this.ctx.measureText(s).width+20,c=25;this.ctx.fillStyle="rgba(0,0,0,0.6)",this.ctx.strokeStyle="white",this.ctx.lineWidth=1,this.ctx.beginPath(),this.ctx.roundRect(t-o/2,e-c,o,c,5),this.ctx.fill(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(t-5,e),this.ctx.lineTo(t+5,e),this.ctx.lineTo(t,e+5),this.ctx.fill(),this.ctx.fillStyle=n?"#ff5252":"white",this.ctx.textAlign="center",this.ctx.fillText(s,t,e-7)}}class De{canvas;ctx;images={};registry=null;weatherSystem;playerRenderer;constructor(t,e){this.canvas=t,this.ctx=e,this.weatherSystem=new Se(t,e),this.loadBaseImages(),this.setupResize(),this.playerRenderer=new Me(e,this.images,s=>this.getObjectImage(s))}setRegistry(t){this.registry=t,this.loadRegistryImages(t)}setWeatherEnabled(t){this.weatherSystem.setWeatherEnabled(t)}setupResize(){window.addEventListener("resize",()=>{this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight})}getAssetUrl(t){return`${t}`}loadImage(t,e){if(this.images[t])return;const s=new Image;s.crossOrigin="anonymous",s.src=this.getAssetUrl(e),this.images[t]=s,s.onload=()=>{try{const n=Math.max(s.naturalWidth||128,128),r=document.createElement("canvas");r.width=n,r.height=n;const o=r.getContext("2d");o&&(o.drawImage(s,0,0,n,n),this.images[t]=r)}catch(n){console.warn("Failed to rasterize image",e,n)}}}loadBaseImages(){const t={grass:"/assets/grass.svg",player:"/assets/player.svg",player_male:"/assets/player_male.svg",player_female:"/assets/player_female.svg",baby:"/assets/baby.svg"};for(const e in t)this.loadImage(e,t[e])}loadRegistryImages(t){for(const e in t.animals){const n=t.animals[e].assets;for(const r in n){const o=n[r];if(o){const c=`/assets/${o}`;this.loadImage(c,c)}}}for(const e in t.resources){const s=t.resources[e];if(s.asset){const n=`/assets/${s.asset}`;this.loadImage(n,n)}}for(const e in t.items){const s=t.items[e];if(s.asset){const n=`/assets/${s.asset}`;this.loadImage(n,n)}}}getObjectMetadata(t){if(!this.registry)return null;const e=Object.values(this.registry.resources).find(r=>r.id===t);if(e)return{...e,category:"resource"};const s=Object.values(this.registry.animals).find(r=>r.id===t);if(s)return{...s,category:"animal"};const n=Object.values(this.registry.items).find(r=>r.id===t);return n?{...n,category:n.category||"item"}:null}getObjectName(t){const e=this.getObjectMetadata(t);return e?e.name:"Unknown"}getObjectImage(t){const e=this.getObjectMetadata(t);return e?e.category==="resource"||e.category==="tool"||e.category==="material"||e.category==="structure"||e.category==="food"||e.category==="weapon"||e.category==="ammo"||e.category==="container"||e.category==="carcass"||e.category==="seed"||e.category==="crop"?this.images[`/assets/${e.asset}`]:e.category==="animal"?this.images[`/assets/${e.assets.alive}`]:null:null}draw(t,e,s,n,r){if(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),!t)return;const o=n?e[n]:null,c=this.canvas.width/2-(o?.x||0),a=this.canvas.height/2-(o?.y||0),h=Ne.TILE_SIZE;this.drawTiles(t,c,a,h);const l=this.collectDrawables(t,e,c,a,h,n);l.sort((f,u)=>f.sortY-u.sortY);for(const f of l)f.draw();this.weatherSystem.applySeasonEffects(r),this.weatherSystem.drawWeather(r),this.drawProjectiles(s,c,a)}collectDrawables(t,e,s,n,r,o){const c=[];for(const a in t.objects){const[h,l]=a.split(","),f=parseInt(h),u=parseInt(l),b=f*r+s,g=u*r+n;if(b+r*2<0||b>this.canvas.width||g+r*2<0||g>this.canvas.height)continue;const x=t.objects[a],O=t.objectsData[a],T=this.getObjectMetadata(x);if(T&&T.isFloor)continue;let P=g+r;T&&T.isLarge&&(P=g+r),c.push({sortY:P,draw:()=>this.drawObject(x,b,g,r,O)})}for(const a in e){const h=e[a];h.x+s;const l=h.y+n,f=a===o;c.push({sortY:l+r/2,draw:()=>this.playerRenderer.drawSingle(h,s,n,r,f)})}return c}biomeColors={grassland:{fill:"#4CAF50",stroke:"rgba(0,0,0,0.03)",detail:"#66BB6A",detail2:"#388E3C"},forest:{fill:"#2E7D32",stroke:"rgba(0,0,0,0.05)",detail:"#43A047",detail2:"#1B5E20"},desert:{fill:"#D4A54A",stroke:"rgba(0,0,0,0.02)",detail:"#E0B76B",detail2:"#C49A38"},swamp:{fill:"#5D7A54",stroke:"rgba(0,0,0,0.06)",detail:"#6B8B60",detail2:"#4A6344"},water:{fill:"#2196F3",stroke:"rgba(0,0,0,0.04)",detail:"#64B5F6",detail2:"#1976D2"}};seededRandom(t,e,s=0){const n=Math.sin(t*12.9898+e*78.233+s)*43758.5453;return n-Math.floor(n)}drawTiles(t,e,s,n){for(let r=0;r<t.tiles.length;r++)for(let o=0;o<t.tiles[r].length;o++){const c=o*n+e,a=r*n+s;if(c+n<0||c>this.canvas.width||a+n<0||a>this.canvas.height)continue;const h=t.tiles[r][o],l=this.biomeColors[h]||this.biomeColors.grassland;this.ctx.fillStyle=l.fill,this.ctx.fillRect(c,a,n,n),this.drawTileTexture(c,a,n,o,r,h,l),this.ctx.strokeStyle=l.stroke,this.ctx.strokeRect(c,a,n,n);const f=`${o},${r}`,u=t.objects[f];if(u){const b=this.getObjectMetadata(u);if(b&&b.isFloor){const g=this.getObjectImage(u),x=g instanceof HTMLCanvasElement||g instanceof HTMLImageElement&&g.complete&&g.naturalWidth>0;g&&x&&this.ctx.drawImage(g,c,a,n,n)}}}}drawTileTexture(t,e,s,n,r,o,c){const a=this.ctx;if(o==="grassland"||o==="forest")for(let h=0;h<6;h++){const l=this.seededRandom(n,r,h*3)*(s-8)+4,f=this.seededRandom(n,r,h*3+1)*(s-8)+4,u=3+this.seededRandom(n,r,h*3+2)*4;a.strokeStyle=this.seededRandom(n,r,h*5)>.5?c.detail:c.detail2,a.lineWidth=1,a.beginPath(),a.moveTo(t+l,e+f+u),a.quadraticCurveTo(t+l-2,e+f+u/2,t+l,e+f),a.stroke(),a.beginPath(),a.moveTo(t+l,e+f+u),a.quadraticCurveTo(t+l+2,e+f+u/2,t+l+1,e+f+1),a.stroke()}else if(o==="desert")for(let h=0;h<4;h++){const l=this.seededRandom(n,r,h*2)*(s-6)+3,f=this.seededRandom(n,r,h*2+1)*(s-6)+3;a.fillStyle=this.seededRandom(n,r,h*4)>.5?c.detail:c.detail2,a.beginPath(),a.arc(t+l,e+f,1.5,0,Math.PI*2),a.fill()}else if(o==="swamp")for(let h=0;h<3;h++){const l=this.seededRandom(n,r,h*2)*(s-12)+6,f=this.seededRandom(n,r,h*2+1)*(s-12)+6,u=4+this.seededRandom(n,r,h*3)*6;a.fillStyle="rgba(60, 80, 50, 0.3)",a.beginPath(),a.ellipse(t+l,e+f,u,u*.6,0,0,Math.PI*2),a.fill()}else if(o==="water"){const h=Date.now()/1e3;for(let u=0;u<3;u++){const b=this.seededRandom(n,r,u*2)*(s-16)+8,g=this.seededRandom(n,r,u*2+1)*(s-16)+8,x=Math.sin(h+n*.5+r*.3+u)*2;a.strokeStyle=c.detail,a.lineWidth=1.5,a.beginPath(),a.arc(t+b+x,e+g,6+u*2,0,Math.PI),a.stroke()}const l=this.seededRandom(n,r,99)*(s-10)+5,f=this.seededRandom(n,r,100)*(s-10)+5;a.fillStyle="rgba(255, 255, 255, 0.3)",a.beginPath(),a.ellipse(t+l,e+f,4,2,.5,0,Math.PI*2),a.fill()}}drawObject(t,e,s,n,r){const o=this.getObjectImage(t),c=this.getObjectMetadata(t),a=o instanceof HTMLCanvasElement||o instanceof HTMLImageElement&&o.complete&&o.naturalWidth>0;if(o&&a){let h=n,l=n,f=0;if(c)if(c.isLarge){const u=c.size||2,b=o instanceof HTMLImageElement?o.naturalWidth||1:o.width,g=o instanceof HTMLImageElement?o.naturalHeight||1:o.height,x=b/g;l=n*u,h=l*x,f=c.yOffset||n,e=e+(n-h)/2}else c.category==="animal"&&(h=n*1.2,l=n*1.2,f=n*.2);if(this.ctx.drawImage(o,e,s-f,h,l),r?.buriedName||r?.name){const u=r.buriedName||r.name,b=r.buriedAge!==void 0?r.buriedAge:r.age!==void 0?r.age:"?";this.ctx.save(),this.ctx.fillStyle="white",this.ctx.font="bold 12px Arial",this.ctx.textAlign="center",this.ctx.shadowColor="black",this.ctx.shadowBlur=4,this.ctx.fillText(`${u} (${b})`,e+n/2,s-f-5),this.ctx.restore()}r?.hp!==void 0&&c?.category==="animal"&&this.drawHealthBar(e,s-f-5,n,r.hp,c.hp||100),r?.inventory?.length>0&&r.inventory.forEach((u,b)=>{const g=this.getObjectImage(u),x=g instanceof HTMLCanvasElement||g instanceof HTMLImageElement&&g.complete;g&&x&&this.ctx.drawImage(g,e+5+b*15,s+10,20,20)})}else this.ctx.fillStyle=c?.category==="animal"?"#E91E63":c?.name==="Tree"?"#795548":c?.name==="Rock"?"#9E9E9E":"black",this.ctx.beginPath(),this.ctx.arc(e+n/2,s+n/2,10,0,Math.PI*2),this.ctx.fill()}drawHealthBar(t,e,s,n,r){const o=s*.8,c=4,a=t+(s-o)/2;this.ctx.fillStyle="rgba(0,0,0,0.5)",this.ctx.fillRect(a,e,o,c);const h=Math.max(0,n/r);this.ctx.fillStyle=h>.5?"#4CAF50":h>.2?"#FFC107":"#F44336",this.ctx.fillRect(a,e,o*h,c)}drawProjectiles(t,e,s){t.forEach(n=>{const r=n.x+e,o=n.y+s,c=this.getObjectImage(n.type),a=c instanceof HTMLCanvasElement||c instanceof HTMLImageElement&&c.complete&&c.naturalWidth>0;c&&a&&(this.ctx.save(),this.ctx.translate(r,o),this.ctx.rotate(n.angle+Math.PI/4),this.ctx.drawImage(c,-10,-10,20,20),this.ctx.restore())})}}let y=null,p={},_=null,Pt=[],$="spring",Nt=[];const ht="onelife_session_token";function Ie(){return localStorage.getItem(ht)}function yt(){localStorage.removeItem(ht)}const I=document.getElementById("gameCanvas"),Le=I.getContext("2d");I.width=window.innerWidth;I.height=window.innerHeight;const D=new Ae,qe=new Ee,W=new De(I,Le),w=new Pe(D.getSocket(),i=>W.getObjectName(i)),B=new Oe(I,D.getSocket(),qe),bt=Ie();bt?D.emit("requestReconnect",{sessionToken:bt}):D.emit("requestBirth");w.setOnChatFocusChange(i=>B.setChatting(i));B.setCallbacks({onChatFocus:()=>w.focusChat(),onToggleRecipeBook:()=>w.toggleRecipeBook(Nt),onShowObjectActions:(i,t)=>w.showObjectActions(i,t)});B.setPlayerHoldingGetter(()=>y&&p[y]?p[y].holding:null);B.setPlayerDataGetter(()=>y&&p[y]?{x:p[y].x,y:p[y].y,holding:p[y].holding}:null);B.setWorldDataGetter(()=>_?{objects:_.objects}:null);B.setPlayersDataGetter(()=>p);B.setMyIdGetter(()=>y);D.setCallbacks({onInit:i=>{p=i.players,_=i.world,$=i.season,y=i.myId,Nt=i.recipes,W.setRegistry(i.registry),B.setRegistry(i.registry),B.setRecipes(i.recipes),w.setRecipes(i.recipes),W.setWeatherEnabled(i.config.weatherEnabled!==!1),w.updateSeason($),i.reconnected&&y&&p[y]&&console.log("[Reconnect] Player position:",p[y].x,p[y].y),i.sessionToken&&localStorage.setItem(ht,i.sessionToken),i.reconnected&&w.showNotification("You have been reconnected to your character!")},onNewPlayer:i=>{p[i.id]=i},onPlayerMoved:i=>{p[i.id]=i},onPlayerStatUpdate:i=>{p[i.id]&&(i.age!==void 0&&(p[i.id].age=i.age),i.hunger!==void 0&&(p[i.id].hunger=i.hunger),i.maxHunger!==void 0&&(p[i.id].maxHunger=i.maxHunger),i.holding!==void 0&&(p[i.id].holding=i.holding),i.holdingData!==void 0&&(p[i.id].holdingData=i.holdingData),i.heldBy!==void 0&&(p[i.id].heldBy=i.heldBy),i.holdingPlayerId!==void 0&&(p[i.id].holdingPlayerId=i.holdingPlayerId),i.name!==void 0&&(p[i.id].name=i.name),i.inBoat!==void 0&&(p[i.id].inBoat=i.inBoat),i.isDead!==void 0&&(p[i.id].isDead=i.isDead),i.backpack!==void 0&&(p[i.id].backpack=i.backpack),i.backpackData!==void 0&&(p[i.id].backpackData=i.backpackData))},onWorldUpdate:i=>{if(!_)return;const t=`${i.x},${i.y}`;i.type===null?(delete _.objects[t],delete _.objectsData[t]):(_.objects[t]=i.type,i.data?_.objectsData[t]=i.data:delete _.objectsData[t])},onPlayerDied:i=>{delete p[i.id],i.id===y&&yt()},onPlayerDisconnected:i=>{delete p[i]},onSeasonChange:i=>{$=i,w.updateSeason(i)},onProjectileUpdate:i=>{Pt=i},onChatMsg:i=>{p[i.id]&&(p[i.id].lastMsg=i.text,p[i.id].lastMsgTime=Date.now()),w.addChatMessage(i.name,i.text)},onDeathScreen:i=>{yt(),w.showDeathScreen(i)},onTextMessage:i=>w.showNotification(i.text),onNameBaby:i=>w.showNamingModal(i),onNameError:i=>w.showNameError(i.message),onNameSuccess:()=>w.hideNamingModal()});function Mt(){try{if(B.update(),y&&p[y]){const i=p[y];w.updatePlayerStats({age:i.age,hunger:i.hunger,maxHunger:i.maxHunger||20,experience:i.experience||0,x:i.x,y:i.y,holding:i.holding,holdingData:i.holdingData,heldBy:i.heldBy,holdingPlayerId:i.holdingPlayerId})}W.draw(_,p,Pt,y,$)}catch(i){console.error("Game loop error:",i)}requestAnimationFrame(Mt)}Mt();
